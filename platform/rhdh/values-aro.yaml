# =============================================================================
# THREE HORIZONS ACCELERATOR - RHDH CONFIGURATION FOR ARO (OpenShift)
# =============================================================================
#
# ARO-specific overrides for Red Hat Developer Hub deployment.
# This file is used with: helm install -f values.yaml -f values-aro.yaml
#
# Key differences from AKS:
#   - Uses OpenShift Routes instead of Ingress
#   - Leverages OpenShift OAuth for authentication
#   - Uses OpenShift service serving certificates
#   - Integrates with OpenShift monitoring stack
#   - Supports operator-based deployment
#
# =============================================================================

# Global ARO configuration
global:
  clusterRouterBase: apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
  
  # ARO uses OpenShift service CA
  caBundle:
    enabled: true
    secretName: openshift-service-ca
    key: service-ca.crt

# =============================================================================
# BACKSTAGE ARO-SPECIFIC OVERRIDES
# =============================================================================

upstream:
  backstage:
    # -------------------------------------------------------------------------
    # ARO Security Context
    # -------------------------------------------------------------------------
    # OpenShift requires specific SCC settings
    podSecurityContext:
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault
        
    containerSecurityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault
        
    # -------------------------------------------------------------------------
    # OpenShift Route (instead of Ingress)
    # -------------------------------------------------------------------------
    ingress:
      enabled: false  # Disabled - using OpenShift Route
      
    # -------------------------------------------------------------------------
    # Service Account with OpenShift RBAC
    # -------------------------------------------------------------------------
    serviceAccount:
      create: true
      name: rhdh
      annotations:
        # For ARO workload identity (Azure AD Pod Identity v2)
        azure.workload.identity/client-id: ${RHDH_MANAGED_IDENTITY_CLIENT_ID}
        # OpenShift specific
        serviceaccounts.openshift.io/oauth-redirectreference.primary: '{"kind":"OAuthRedirectReference","apiVersion":"v1","reference":{"kind":"Route","name":"rhdh"}}'
        
    podLabels:
      azure.workload.identity/use: "true"
      app.kubernetes.io/component: rhdh
      app.openshift.io/runtime: nodejs

    # -------------------------------------------------------------------------
    # App Config ARO Overrides
    # -------------------------------------------------------------------------
    appConfig:
      app:
        title: "${CUSTOMER_NAME} Developer Hub"
        baseUrl: https://rhdh-${NAMESPACE}.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
        
      backend:
        baseUrl: https://rhdh-${NAMESPACE}.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
        listen:
          port: 7007
        cors:
          origin: https://rhdh-${NAMESPACE}.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
          methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
          credentials: true
          
      # -----------------------------------------------------------------------
      # OpenShift OAuth Authentication (alternative to GitHub)
      # -----------------------------------------------------------------------
      auth:
        environment: production
        providers:
          # GitHub remains primary
          github:
            production:
              clientId: ${GITHUB_APP_CLIENT_ID}
              clientSecret: ${GITHUB_APP_CLIENT_SECRET}
              enterpriseInstanceUrl: https://github.com
              signIn:
                resolvers:
                  - resolver: usernameMatchingUserEntityName
                  
          # OpenShift OAuth as supplementary provider
          oauth2Proxy:
            production:
              clientId: rhdh
              clientSecret: ${OAUTH2_PROXY_CLIENT_SECRET}
              signIn:
                resolvers:
                  - resolver: usernameMatchingUserEntityName
                  
      # -----------------------------------------------------------------------
      # Kubernetes Plugin for OpenShift
      # -----------------------------------------------------------------------
      kubernetes:
        serviceLocatorMethod:
          type: multiTenant
        clusterLocatorMethods:
          - type: config
            clusters:
              - url: https://kubernetes.default.svc
                name: production
                authProvider: serviceAccount
                skipTLSVerify: false
                skipMetricsLookup: false
                serviceAccountToken: ${K8S_SERVICE_ACCOUNT_TOKEN}
                # OpenShift console URL
                dashboardUrl: https://console-openshift-console.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
                dashboardApp: openshift
                
      # -----------------------------------------------------------------------
      # OpenShift-specific proxy endpoints
      # -----------------------------------------------------------------------
      proxy:
        endpoints:
          '/argocd/api':
            target: https://argocd-server-argocd.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}/api/v1
            headers:
              Cookie:
                $env: ARGOCD_AUTH_TOKEN
            changeOrigin: true
            secure: true
            
          '/prometheus/api':
            # OpenShift built-in monitoring
            target: https://thanos-querier-openshift-monitoring.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
            headers:
              Authorization:
                $env: THANOS_TOKEN
            changeOrigin: true
            secure: true
            
          '/tekton/api':
            target: https://tekton-dashboard-openshift-pipelines.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
            changeOrigin: true
            secure: true

# =============================================================================
# OPENSHIFT ROUTE
# =============================================================================

route:
  enabled: true
  annotations:
    haproxy.router.openshift.io/timeout: 300s
    haproxy.router.openshift.io/rewrite-target: /
  host: rhdh-${NAMESPACE}.apps.${CLUSTER_NAME}.${DNS_ZONE_NAME}
  path: /
  tls:
    enabled: true
    termination: edge
    insecureEdgeTerminationPolicy: Redirect
  wildcardPolicy: None

# =============================================================================
# OPENSHIFT DYNAMIC PLUGINS (additional)
# =============================================================================

global:
  dynamic:
    includes:
      - dynamic-plugins.default.yaml
    plugins:
      # All plugins from values.yaml plus OpenShift-specific
      
      # GitHub Plugins (inherited)
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-github-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-catalog-backend-module-github-org-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-github-actions
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-github-issues
        disabled: false
        
      # Kubernetes Plugins (inherited)
      - package: ./dynamic-plugins/dist/backstage-plugin-kubernetes-backend-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-kubernetes
        disabled: false
        
      # ArgoCD Plugins (inherited)
      - package: ./dynamic-plugins/dist/roadiehq-backstage-plugin-argo-cd-backend-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/roadiehq-backstage-plugin-argo-cd
        disabled: false
        
      # TechDocs (inherited)
      - package: ./dynamic-plugins/dist/backstage-plugin-techdocs-backend-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/backstage-plugin-techdocs
        disabled: false
        
      # Scaffolder Actions (inherited)
      - package: ./dynamic-plugins/dist/backstage-plugin-scaffolder-backend-module-github-dynamic
        disabled: false
      - package: ./dynamic-plugins/dist/roadiehq-scaffolder-backend-argocd-dynamic
        disabled: false
        
      # Security (GHAS integration)
      - package: ./dynamic-plugins/dist/backstage-plugin-security-insights
        disabled: false
        
      # ========== OpenShift-Specific Plugins ==========
      
      # OpenShift Console Plugin
      - package: ./dynamic-plugins/dist/janus-idp-backstage-plugin-openshift-console
        disabled: false
        
      # OpenShift Image Registry Plugin
      - package: ./dynamic-plugins/dist/janus-idp-backstage-plugin-openshift-image-registry
        disabled: false
        
      # Tekton (OpenShift Pipelines) Plugin
      - package: ./dynamic-plugins/dist/janus-idp-backstage-plugin-tekton
        disabled: false
      - package: ./dynamic-plugins/dist/janus-idp-backstage-plugin-tekton-backend-dynamic
        disabled: false
        
      # OpenShift Topology Plugin
      - package: ./dynamic-plugins/dist/janus-idp-backstage-plugin-topology
        disabled: false

# =============================================================================
# POSTGRESQL (OpenShift)
# =============================================================================

postgresql:
  enabled: false  # Using external Azure PostgreSQL (same as AKS)
  
# =============================================================================
# OPENSHIFT OPERATOR DEPLOYMENT (alternative to Helm)
# =============================================================================
# 
# For operator-based deployment, use the RHDH Operator CRD:
#
# apiVersion: rhdh.redhat.com/v1alpha1
# kind: Backstage
# metadata:
#   name: developer-hub
#   namespace: ${NAMESPACE}
# spec:
#   application:
#     replicas: 2
#     route:
#       enabled: true
#     appConfig:
#       configMaps:
#         - name: rhdh-app-config
#       secrets:
#         - name: rhdh-secrets
#   database:
#     enableLocalDb: false
#     secret: rhdh-database-secret
#
# =============================================================================

# =============================================================================
# SCC (Security Context Constraints) REQUIREMENTS
# =============================================================================
#
# The RHDH deployment requires a specific SCC. Create it with:
#
# kind: SecurityContextConstraints
# apiVersion: security.openshift.io/v1
# metadata:
#   name: rhdh-scc
# allowHostDirVolumePlugin: false
# allowHostIPC: false
# allowHostNetwork: false
# allowHostPID: false
# allowHostPorts: false
# allowPrivilegedContainer: false
# allowPrivilegeEscalation: false
# readOnlyRootFilesystem: false
# runAsUser:
#   type: MustRunAsNonRoot
# seLinuxContext:
#   type: MustRunAs
# fsGroup:
#   type: MustRunAs
#   ranges:
#     - min: 1000
#       max: 4000
# supplementalGroups:
#   type: MustRunAs
#   ranges:
#     - min: 1000
#       max: 4000
# volumes:
#   - configMap
#   - downwardAPI
#   - emptyDir
#   - persistentVolumeClaim
#   - projected
#   - secret
# users:
#   - system:serviceaccount:${NAMESPACE}:rhdh
#
# Apply with: oc create -f scc.yaml
# Assign with: oc adm policy add-scc-to-user rhdh-scc -z rhdh -n ${NAMESPACE}
#
# =============================================================================

# =============================================================================
# NETWORKPOLICY FOR OPENSHIFT
# =============================================================================

networkPolicy:
  enabled: true
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              network.openshift.io/policy-group: ingress
        - podSelector: {}
  egress:
    - to:
        - namespaceSelector: {}
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 169.254.169.254/32  # Block Azure IMDS except for workload identity
