# =============================================================================
# ARGOCD APPLICATION - EXTERNAL SECRETS OPERATOR
# =============================================================================
#
# Deploys External Secrets Operator for Kubernetes secret management
# with Azure Key Vault integration.
#
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-secrets
  namespace: argocd
  labels:
    app.kubernetes.io/name: external-secrets
    app.kubernetes.io/component: secrets-management
    app.kubernetes.io/part-of: platform-security
    platform.three-horizons/tier: h1-foundation
  annotations:
    argocd.argoproj.io/sync-wave: "10"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  source:
    repoURL: https://charts.external-secrets.io
    targetRevision: 0.9.11
    chart: external-secrets
    helm:
      releaseName: external-secrets
      values: |
        installCRDs: true

        serviceAccount:
          create: true
          name: external-secrets-controller
          annotations:
            azure.workload.identity/client-id: "${ESO_CLIENT_ID}"

        podLabels:
          azure.workload.identity/use: "true"

        webhook:
          serviceAccount:
            create: true
            name: external-secrets-webhook

        certController:
          serviceAccount:
            create: true
            name: external-secrets-cert-controller

        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi

        prometheus:
          enabled: true
          service:
            port: 8080

        # Pod distribution
        replicaCount: 2

        podDisruptionBudget:
          enabled: true
          minAvailable: 1

        # Security context
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          fsGroup: 1000

        # Tolerations for system node pools
        tolerations:
          - key: CriticalAddonsOnly
            operator: Exists

  destination:
    server: https://kubernetes.default.svc
    namespace: external-secrets

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
      allowEmpty: false
    syncOptions:
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
      - ApplyOutOfSyncOnly=true
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m

  # Health checks
  ignoreDifferences:
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jsonPointers:
        - /webhooks/0/clientConfig/caBundle
    - group: admissionregistration.k8s.io
      kind: MutatingWebhookConfiguration
      jsonPointers:
        - /webhooks/0/clientConfig/caBundle

---
# =============================================================================
# CLUSTER SECRET STORE - AZURE KEY VAULT
# =============================================================================

apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-secrets-config
  namespace: argocd
  labels:
    app.kubernetes.io/name: external-secrets-config
    app.kubernetes.io/component: secrets-management
  annotations:
    argocd.argoproj.io/sync-wave: "15"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: platform

  source:
    repoURL: https://github.com/${GITHUB_ORG}/three-horizons-accelerator-v4.git
    targetRevision: HEAD
    path: argocd/secrets

  destination:
    server: https://kubernetes.default.svc
    namespace: external-secrets

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=false
