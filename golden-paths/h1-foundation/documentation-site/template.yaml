# =============================================================================
# THREE HORIZONS ACCELERATOR - H1 DOCUMENTATION SITE GOLDEN PATH TEMPLATE
# =============================================================================
#
# RHDH Software Template for creating documentation sites.
# Integrates with TechDocs, GitHub Pages, and static site generators.
#
# Horizon: H1 - Foundation
# Use Case: Create standardized documentation for projects and APIs
#
# =============================================================================

apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: h1-documentation-site
  title: "H1: Create Documentation Site"
  description: |
    Create a documentation site using your preferred static site generator.
    Automatically integrates with RHDH TechDocs for unified documentation.
  tags:
    - h1-foundation
    - documentation
    - techdocs
    - markdown
    - developer-portal
  annotations:
    backstage.io/techdocs-ref: dir:.
  links:
    - title: TechDocs Documentation
      url: https://backstage.io/docs/features/techdocs/

spec:
  owner: platform-engineering
  type: documentation

  # ===========================================================================
  # PARAMETERS
  # ===========================================================================
  
  parameters:
    # -------------------------------------------------------------------------
    # Documentation Information
    # -------------------------------------------------------------------------
    - title: Documentation Information
      required:
        - siteName
        - team
        - docType
      properties:
        siteName:
          title: Site Name
          description: Name of the documentation site
          type: string
          pattern: '^[a-z][a-z0-9-]*-docs$'
          maxLength: 50

        team:
          title: Team
          description: Team that owns this documentation
          type: string
          ui:field: OwnerPicker
          ui:options:
            catalogFilter:
              kind: Group

        description:
          title: Description
          description: Brief description of what this documentation covers
          type: string
          maxLength: 300

        docType:
          title: Documentation Type
          description: Primary type of documentation
          type: string
          enum:
            - api-reference
            - user-guide
            - developer-guide
            - architecture
            - runbook
            - onboarding
            - general
          enumNames:
            - API Reference
            - User Guide
            - Developer Guide
            - Architecture Documentation
            - Operations Runbook
            - Onboarding Guide
            - General Documentation

    # -------------------------------------------------------------------------
    # Generator & Framework
    # -------------------------------------------------------------------------
    - title: Generator & Framework
      required:
        - generator
      properties:
        generator:
          title: Static Site Generator
          description: Choose your preferred documentation framework
          type: string
          default: mkdocs
          enum:
            - mkdocs
            - docusaurus
            - sphinx
            - hugo
            - vitepress
            - astro
          enumNames:
            - MkDocs (Material theme)
            - Docusaurus (React-based)
            - Sphinx (Python docs)
            - Hugo (Fast builds)
            - VitePress (Vue-based)
            - Astro (Modern framework)

        theme:
          title: Theme
          description: Documentation theme
          type: string
          default: material
          enum:
            - material
            - readthedocs
            - gitbook
            - custom
          enumNames:
            - Material Design
            - Read the Docs
            - GitBook Style
            - Custom Theme

        enableSearch:
          title: Enable Search
          type: boolean
          default: true

        enableVersioning:
          title: Enable Versioning
          description: Support multiple documentation versions
          type: boolean
          default: false

    # -------------------------------------------------------------------------
    # Content Structure
    # -------------------------------------------------------------------------
    - title: Content Structure
      properties:
        sections:
          title: Documentation Sections
          description: Select sections to include
          type: array
          items:
            type: string
            enum:
              - getting-started
              - installation
              - configuration
              - api-reference
              - tutorials
              - how-to-guides
              - architecture
              - troubleshooting
              - faq
              - changelog
              - contributing
          uniqueItems: true
          default:
            - getting-started
            - installation
            - configuration

        includeApiDocs:
          title: Include API Documentation
          description: Generate API docs from OpenAPI/Swagger spec
          type: boolean
          default: false

        apiSpecUrl:
          title: OpenAPI Spec URL
          description: URL to OpenAPI specification (if including API docs)
          type: string
          format: uri

        includeCodeSamples:
          title: Include Code Samples
          description: Add code sample sections
          type: boolean
          default: true

        sampleLanguages:
          title: Code Sample Languages
          type: array
          items:
            type: string
            enum:
              - python
              - javascript
              - typescript
              - java
              - csharp
              - go
              - bash
              - powershell
          default:
            - python
            - javascript

    # -------------------------------------------------------------------------
    # TechDocs Integration
    # -------------------------------------------------------------------------
    - title: TechDocs Integration
      properties:
        enableTechDocs:
          title: Enable TechDocs Integration
          description: Publish to RHDH TechDocs
          type: boolean
          default: true

        techDocsStorage:
          title: TechDocs Storage
          description: Where to store generated docs
          type: string
          default: azure-blob
          enum:
            - azure-blob
            - s3
            - gcs
            - local
          enumNames:
            - Azure Blob Storage
            - AWS S3
            - Google Cloud Storage
            - Local (Dev only)

        autoPublish:
          title: Auto-Publish on Merge
          description: Automatically publish docs on main branch merge
          type: boolean
          default: true

    # -------------------------------------------------------------------------
    # Hosting & Deployment
    # -------------------------------------------------------------------------
    - title: Hosting & Deployment
      properties:
        hosting:
          title: Hosting Platform
          type: string
          default: github-pages
          enum:
            - github-pages
            - azure-static-web
            - cloudflare-pages
            - netlify
            - techdocs-only
          enumNames:
            - GitHub Pages
            - Azure Static Web Apps
            - Cloudflare Pages
            - Netlify
            - TechDocs Only (no public site)

        customDomain:
          title: Custom Domain
          description: Custom domain for the documentation site (optional)
          type: string
          format: hostname

        enableAnalytics:
          title: Enable Analytics
          type: boolean
          default: false

        analyticsProvider:
          title: Analytics Provider
          type: string
          default: google
          enum:
            - google
            - plausible
            - fathom
            - none

    # -------------------------------------------------------------------------
    # Repository
    # -------------------------------------------------------------------------
    - title: Repository Configuration
      required:
        - repoUrl
      properties:
        repoUrl:
          title: Repository Location
          type: string
          ui:field: RepoUrlPicker
          ui:options:
            allowedHosts:
              - github.com

        createSeparateRepo:
          title: Create Separate Repository
          description: Create a dedicated docs repo (vs adding to existing)
          type: boolean
          default: true

  # ===========================================================================
  # STEPS
  # ===========================================================================
  
  steps:
    # -------------------------------------------------------------------------
    # Fetch Base Template
    # -------------------------------------------------------------------------
    - id: fetch-template
      name: Fetch Documentation Template
      action: fetch:template
      input:
        url: ./skeleton
        targetPath: ./repo
        values:
          siteName: ${{ parameters.siteName }}
          team: ${{ parameters.team }}
          description: ${{ parameters.description }}
          docType: ${{ parameters.docType }}
          generator: ${{ parameters.generator }}
          theme: ${{ parameters.theme }}
          enableSearch: ${{ parameters.enableSearch }}
          sections: ${{ parameters.sections }}
          enableTechDocs: ${{ parameters.enableTechDocs }}
          hosting: ${{ parameters.hosting }}

    # -------------------------------------------------------------------------
    # Generate MkDocs Configuration
    # -------------------------------------------------------------------------
    - id: generate-mkdocs
      name: Generate MkDocs Configuration
      if: ${{ parameters.generator === 'mkdocs' }}
      action: fetch:template
      input:
        url: ./skeleton/mkdocs
        targetPath: ./repo
        values:
          siteName: ${{ parameters.siteName }}
          description: ${{ parameters.description }}
          theme: ${{ parameters.theme }}
          enableSearch: ${{ parameters.enableSearch }}
          enableVersioning: ${{ parameters.enableVersioning }}
          sections: ${{ parameters.sections }}

    # -------------------------------------------------------------------------
    # Generate Docusaurus Configuration
    # -------------------------------------------------------------------------
    - id: generate-docusaurus
      name: Generate Docusaurus Configuration
      if: ${{ parameters.generator === 'docusaurus' }}
      action: fetch:template
      input:
        url: ./skeleton/docusaurus
        targetPath: ./repo
        values:
          siteName: ${{ parameters.siteName }}
          description: ${{ parameters.description }}
          enableVersioning: ${{ parameters.enableVersioning }}
          sections: ${{ parameters.sections }}

    # -------------------------------------------------------------------------
    # Generate Content Sections
    # -------------------------------------------------------------------------
    - id: generate-content
      name: Generate Content Sections
      action: fetch:template
      input:
        url: ./skeleton/content
        targetPath: ./repo/docs
        values:
          siteName: ${{ parameters.siteName }}
          description: ${{ parameters.description }}
          docType: ${{ parameters.docType }}
          sections: ${{ parameters.sections }}
          includeCodeSamples: ${{ parameters.includeCodeSamples }}
          sampleLanguages: ${{ parameters.sampleLanguages }}

    # -------------------------------------------------------------------------
    # Generate CI/CD Workflows
    # -------------------------------------------------------------------------
    - id: generate-cicd
      name: Generate CI/CD Workflows
      action: fetch:template
      input:
        url: ./skeleton/workflows
        targetPath: ./repo/.github/workflows
        values:
          generator: ${{ parameters.generator }}
          hosting: ${{ parameters.hosting }}
          enableTechDocs: ${{ parameters.enableTechDocs }}
          autoPublish: ${{ parameters.autoPublish }}

    # -------------------------------------------------------------------------
    # Create Repository
    # -------------------------------------------------------------------------
    - id: create-repo
      name: Create GitHub Repository
      action: publish:github
      input:
        allowedHosts: ['github.com']
        repoUrl: ${{ parameters.repoUrl }}
        description: "Documentation: ${{ parameters.description }}"
        defaultBranch: main
        repoVisibility: internal
        sourcePath: ./repo

    # -------------------------------------------------------------------------
    # Register in Catalog
    # -------------------------------------------------------------------------
    - id: register-catalog
      name: Register in Catalog
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['create-repo'].output.repoContentsUrl }}
        catalogInfoPath: /catalog-info.yaml

  # ===========================================================================
  # OUTPUT
  # ===========================================================================
  
  output:
    links:
      - title: Repository
        url: ${{ steps['create-repo'].output.remoteUrl }}
      - title: Open in Catalog
        icon: catalog
        entityRef: ${{ steps['register-catalog'].output.entityRef }}
      - title: View TechDocs
        icon: docs
        url: /docs/default/component/${{ parameters.siteName }}
    text:
      - title: Documentation Site Created
        content: |
          ## üìö Documentation Site Created!
          
          **Site:** ${{ parameters.siteName }}
          **Type:** ${{ parameters.docType }}
          **Generator:** ${{ parameters.generator }}
          
          **Features:**
          - ${{ parameters.enableSearch ? '‚úÖ' : '‚è≠Ô∏è' }} Search
          - ${{ parameters.enableVersioning ? '‚úÖ' : '‚è≠Ô∏è' }} Versioning
          - ${{ parameters.enableTechDocs ? '‚úÖ' : '‚è≠Ô∏è' }} TechDocs Integration
          - ${{ parameters.includeApiDocs ? '‚úÖ' : '‚è≠Ô∏è' }} API Documentation
          
          **Sections Created:**
          ${{ parameters.sections | join(', ') }}
          
          **Next Steps:**
          1. Clone the repository
          2. Edit documentation in `docs/` folder
          3. Preview locally with `make serve`
          4. Push changes to publish

---
# =============================================================================
# SKELETON FILES
# =============================================================================

# skeleton/mkdocs.yml (for MkDocs generator)
site_name: ${{ values.siteName | replace('-docs', '') | title }} Documentation
site_description: ${{ values.description }}
site_author: ${{ values.team }}

repo_name: ${{ values.siteName }}
repo_url: https://github.com/example/${{ values.siteName }}
edit_uri: edit/main/docs/

theme:
  name: material
  {%- if values.theme == 'material' %}
  palette:
    - scheme: default
      primary: blue
      accent: blue
      toggle:
        icon: material/brightness-7
        name: Switch to dark mode
    - scheme: slate
      primary: blue
      accent: blue
      toggle:
        icon: material/brightness-4
        name: Switch to light mode
  features:
    - navigation.instant
    - navigation.tracking
    - navigation.tabs
    - navigation.sections
    - navigation.expand
    - navigation.top
    - search.highlight
    - search.share
    - content.code.copy
    - content.code.annotate
  {%- endif %}

plugins:
  {%- if values.enableSearch %}
  - search:
      lang: en
  {%- endif %}
  - techdocs-core
  {%- if values.enableVersioning %}
  - mike:
      version_selector: true
  {%- endif %}

markdown_extensions:
  - pymdownx.highlight:
      anchor_linenums: true
  - pymdownx.inlinehilite
  - pymdownx.snippets
  - pymdownx.superfences:
      custom_fences:
        - name: mermaid
          class: mermaid
          format: !!python/name:pymdownx.superfences.fence_code_format
  - admonition
  - pymdownx.details
  - pymdownx.tabbed:
      alternate_style: true
  - attr_list
  - md_in_html
  - toc:
      permalink: true

nav:
  - Home: index.md
  {%- if 'getting-started' in values.sections %}
  - Getting Started:
    - Overview: getting-started/index.md
    - Quick Start: getting-started/quickstart.md
  {%- endif %}
  {%- if 'installation' in values.sections %}
  - Installation:
    - Requirements: installation/requirements.md
    - Setup: installation/setup.md
  {%- endif %}
  {%- if 'configuration' in values.sections %}
  - Configuration:
    - Basic Configuration: configuration/basic.md
    - Advanced Options: configuration/advanced.md
  {%- endif %}
  {%- if 'api-reference' in values.sections %}
  - API Reference:
    - Overview: api/index.md
    - Endpoints: api/endpoints.md
  {%- endif %}
  {%- if 'tutorials' in values.sections %}
  - Tutorials:
    - tutorials/index.md
  {%- endif %}
  {%- if 'troubleshooting' in values.sections %}
  - Troubleshooting:
    - Common Issues: troubleshooting/common-issues.md
    - FAQ: troubleshooting/faq.md
  {%- endif %}

---
# skeleton/docs/index.md
# ${{ values.siteName | replace('-docs', '') | title }}

${{ values.description }}

## Overview

Welcome to the ${{ values.siteName | replace('-docs', '') | title }} documentation!

{%- if values.docType == 'api-reference' %}
This documentation provides comprehensive API reference for developers integrating with our services.
{%- elif values.docType == 'user-guide' %}
This guide will help you understand and use our product effectively.
{%- elif values.docType == 'developer-guide' %}
This guide is intended for developers who want to build, extend, or contribute to the project.
{%- elif values.docType == 'architecture' %}
This documentation describes the system architecture, design decisions, and technical specifications.
{%- elif values.docType == 'runbook' %}
This runbook contains operational procedures for managing and troubleshooting the system.
{%- endif %}

## Quick Links

{%- if 'getting-started' in values.sections %}
- üöÄ [Getting Started](getting-started/index.md) - New here? Start here!
{%- endif %}
{%- if 'installation' in values.sections %}
- üì¶ [Installation](installation/requirements.md) - Set up your environment
{%- endif %}
{%- if 'api-reference' in values.sections %}
- üìñ [API Reference](api/index.md) - Complete API documentation
{%- endif %}
{%- if 'tutorials' in values.sections %}
- üìö [Tutorials](tutorials/index.md) - Step-by-step guides
{%- endif %}
{%- if 'troubleshooting' in values.sections %}
- üîß [Troubleshooting](troubleshooting/common-issues.md) - Common issues and solutions
{%- endif %}

## Need Help?

- üìß Contact the team: ${{ values.team }}
- üí¨ Join our Slack channel: #${{ values.siteName | replace('-docs', '') }}
- üêõ Report issues: [GitHub Issues](https://github.com/example/${{ values.siteName }}/issues)

---

*Last updated: {% raw %}{{ git_revision_date_localized }}{% endraw %}*

---
# skeleton/.github/workflows/docs.yml
name: Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '.github/workflows/docs.yml'
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          pip install mkdocs-material mkdocs-techdocs-core
          {%- if values.enableVersioning %}
          pip install mike
          {%- endif %}

      - name: Build Documentation
        run: mkdocs build --strict

      {%- if values.enableTechDocs %}
      - name: Generate TechDocs
        run: |
          npx @techdocs/cli generate --source-dir . --output-dir ./site
      
      - name: Publish TechDocs
        if: github.ref == 'refs/heads/main'
        run: |
          npx @techdocs/cli publish --publisher-type azureBlobStorage \
            --storage-name ${{ "{{" }} secrets.TECHDOCS_STORAGE_ACCOUNT {{ "}}" }} \
            --entity default/component/${{ values.siteName }}
      {%- endif %}

      {%- if values.hosting == 'github-pages' %}
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ "{{" }} secrets.GITHUB_TOKEN {{ "}}" }}
          publish_dir: ./site
      {%- endif %}

---
# skeleton/catalog-info.yaml
apiVersion: backstage.io/v1alpha1
kind: Component
metadata:
  name: ${{ values.siteName }}
  title: ${{ values.siteName | replace('-docs', '') | title }} Documentation
  description: ${{ values.description }}
  annotations:
    backstage.io/techdocs-ref: dir:.
    github.com/project-slug: example/${{ values.siteName }}
  tags:
    - documentation
    - ${{ values.docType }}
  links:
    - url: https://example.github.io/${{ values.siteName }}
      title: Documentation Site
      icon: docs
spec:
  type: documentation
  lifecycle: production
  owner: ${{ values.team }}
