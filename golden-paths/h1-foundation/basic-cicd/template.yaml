# =============================================================================
# THREE HORIZONS ACCELERATOR - H1 BASIC CI/CD GOLDEN PATH TEMPLATE
# =============================================================================
#
# RHDH Software Template for adding CI/CD pipelines to existing repositories.
# Adds GitHub Actions workflows for build, test, security scanning, and deploy.
#
# Horizon: H1 - Foundation
# Use Case: Standardize CI/CD across existing repositories
#
# =============================================================================

apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: h1-basic-cicd
  title: "H1: Add CI/CD Pipeline to Existing Repository"
  description: |
    Add standardized CI/CD pipelines to an existing repository.
    Includes build, test, security scanning (GHAS), and deployment workflows.
  tags:
    - h1-foundation
    - cicd
    - github-actions
    - security
    - recommended
  annotations:
    backstage.io/techdocs-ref: dir:.
  links:
    - title: GitHub Actions Documentation
      url: https://docs.github.com/en/actions
    - title: Three Horizons Guide
      url: https://github.com/{{orgName}}/platform-docs/blob/main/three-horizons.md

spec:
  owner: platform-engineering
  type: cicd-pipeline

  # ===========================================================================
  # PARAMETERS
  # ===========================================================================
  
  parameters:
    # -------------------------------------------------------------------------
    # Repository Selection
    # -------------------------------------------------------------------------
    - title: Repository Selection
      description: Select the existing repository to add CI/CD pipelines
      required:
        - repoUrl
      properties:
        repoUrl:
          title: Repository URL
          description: The existing GitHub repository
          type: string
          ui:field: RepoUrlPicker
          ui:options:
            allowedHosts:
              - github.com
            allowedOwners:
              - ${{ parameters.orgName | default('your-org') }}

        branch:
          title: Target Branch
          description: Branch to add the CI/CD configuration
          type: string
          default: main
          enum:
            - main
            - master
            - develop

    # -------------------------------------------------------------------------
    # Application Type
    # -------------------------------------------------------------------------
    - title: Application Configuration
      description: Configure the application type and build settings
      required:
        - applicationType
        - language
      properties:
        applicationType:
          title: Application Type
          description: Type of application in the repository
          type: string
          default: service
          enum:
            - service
            - library
            - cli
            - frontend
            - infrastructure
          enumNames:
            - "Backend Service (API, Microservice)"
            - "Library/Package"
            - "CLI Tool"
            - "Frontend Application"
            - "Infrastructure as Code"

        language:
          title: Programming Language
          description: Primary language of the application
          type: string
          enum:
            - python
            - nodejs
            - java
            - dotnet
            - go
            - typescript
            - terraform
          enumNames:
            - Python
            - Node.js
            - Java (Maven/Gradle)
            - .NET
            - Go
            - TypeScript
            - Terraform

        languageVersion:
          title: Language Version
          description: Version of the programming language
          type: string
          default: "latest"

        packageManager:
          title: Package Manager
          description: Package manager for dependencies
          type: string
          enum:
            - pip
            - poetry
            - npm
            - yarn
            - pnpm
            - maven
            - gradle
            - nuget
            - go-mod
          enumNames:
            - pip (Python)
            - Poetry (Python)
            - npm (Node.js)
            - Yarn (Node.js)
            - pnpm (Node.js)
            - Maven (Java)
            - Gradle (Java)
            - NuGet (.NET)
            - Go Modules

    # -------------------------------------------------------------------------
    # Pipeline Configuration
    # -------------------------------------------------------------------------
    - title: Pipeline Configuration
      description: Configure the CI/CD pipeline features
      properties:
        enableBuild:
          title: Enable Build
          description: Add build workflow
          type: boolean
          default: true

        enableTest:
          title: Enable Tests
          description: Add test workflow with coverage
          type: boolean
          default: true

        testCommand:
          title: Test Command
          description: Custom test command (optional)
          type: string
          ui:widget: textarea
          ui:options:
            rows: 2

        enableLint:
          title: Enable Linting
          description: Add linting and code quality checks
          type: boolean
          default: true

        enableSecurity:
          title: Enable Security Scanning
          description: Enable GitHub Advanced Security (GHAS) scanning
          type: boolean
          default: true

        enableDependencyReview:
          title: Enable Dependency Review
          description: Review dependencies on PRs for vulnerabilities
          type: boolean
          default: true

        enableSonarQube:
          title: Enable SonarQube
          description: Add SonarQube code analysis (requires SonarQube setup)
          type: boolean
          default: false

    # -------------------------------------------------------------------------
    # Deployment Configuration
    # -------------------------------------------------------------------------
    - title: Deployment Configuration
      description: Configure deployment settings
      properties:
        enableDeploy:
          title: Enable Deployment
          description: Add deployment workflow
          type: boolean
          default: true

        deploymentTarget:
          title: Deployment Target
          description: Where to deploy the application
          type: string
          default: aks
          enum:
            - aks
            - container-apps
            - app-service
            - functions
            - static-web
            - none
          enumNames:
            - Azure Kubernetes Service (ArgoCD)
            - Azure Container Apps
            - Azure App Service
            - Azure Functions
            - Azure Static Web Apps
            - No Deployment (CI only)
          ui:widget: radio

        environments:
          title: Environments
          description: Deployment environments
          type: array
          items:
            type: string
            enum:
              - dev
              - staging
              - prod
          uniqueItems: true
          default:
            - dev
            - staging
            - prod

        requireApproval:
          title: Require Approval for Production
          description: Require manual approval for production deployments
          type: boolean
          default: true

    # -------------------------------------------------------------------------
    # Container Configuration (if applicable)
    # -------------------------------------------------------------------------
    - title: Container Configuration
      description: Configure container build settings
      properties:
        buildContainer:
          title: Build Container Image
          description: Build and push container image
          type: boolean
          default: true

        containerRegistry:
          title: Container Registry
          description: Azure Container Registry name
          type: string
          default: ${{ values.acrName | default('acrthreehorizons') }}

        dockerfilePath:
          title: Dockerfile Path
          description: Path to Dockerfile
          type: string
          default: ./Dockerfile

        containerContext:
          title: Build Context
          description: Docker build context path
          type: string
          default: "."

  # ===========================================================================
  # STEPS
  # ===========================================================================
  
  steps:
    # -------------------------------------------------------------------------
    # Fetch Existing Repository
    # -------------------------------------------------------------------------
    - id: fetch-repo
      name: Fetch Existing Repository
      action: fetch:plain
      input:
        url: https://github.com/${{ parameters.repoUrl | parseRepoUrl | pick('owner') }}/${{ parameters.repoUrl | parseRepoUrl | pick('repo') }}
        targetPath: ./repo

    # -------------------------------------------------------------------------
    # Generate CI Workflow
    # -------------------------------------------------------------------------
    - id: generate-ci
      name: Generate CI Workflow
      action: fetch:template
      input:
        url: ./skeleton/workflows/ci
        targetPath: ./repo/.github/workflows
        values:
          language: ${{ parameters.language }}
          languageVersion: ${{ parameters.languageVersion }}
          packageManager: ${{ parameters.packageManager }}
          applicationType: ${{ parameters.applicationType }}
          enableBuild: ${{ parameters.enableBuild }}
          enableTest: ${{ parameters.enableTest }}
          testCommand: ${{ parameters.testCommand }}
          enableLint: ${{ parameters.enableLint }}

    # -------------------------------------------------------------------------
    # Generate Security Workflows
    # -------------------------------------------------------------------------
    - id: generate-security
      name: Generate Security Workflows
      if: ${{ parameters.enableSecurity }}
      action: fetch:template
      input:
        url: ./skeleton/workflows/security
        targetPath: ./repo/.github/workflows
        values:
          language: ${{ parameters.language }}
          enableDependencyReview: ${{ parameters.enableDependencyReview }}

    # -------------------------------------------------------------------------
    # Generate Deployment Workflow
    # -------------------------------------------------------------------------
    - id: generate-deploy
      name: Generate Deployment Workflow
      if: ${{ parameters.enableDeploy }}
      action: fetch:template
      input:
        url: ./skeleton/workflows/deploy
        targetPath: ./repo/.github/workflows
        values:
          deploymentTarget: ${{ parameters.deploymentTarget }}
          environments: ${{ parameters.environments }}
          requireApproval: ${{ parameters.requireApproval }}
          buildContainer: ${{ parameters.buildContainer }}
          containerRegistry: ${{ parameters.containerRegistry }}
          dockerfilePath: ${{ parameters.dockerfilePath }}
          containerContext: ${{ parameters.containerContext }}

    # -------------------------------------------------------------------------
    # Generate Dependabot Config
    # -------------------------------------------------------------------------
    - id: generate-dependabot
      name: Generate Dependabot Configuration
      action: fetch:template
      input:
        url: ./skeleton/dependabot
        targetPath: ./repo/.github
        values:
          language: ${{ parameters.language }}
          packageManager: ${{ parameters.packageManager }}

    # -------------------------------------------------------------------------
    # Generate CODEOWNERS
    # -------------------------------------------------------------------------
    - id: generate-codeowners
      name: Generate CODEOWNERS
      action: fetch:template
      input:
        url: ./skeleton/codeowners
        targetPath: ./repo/.github
        values:
          owner: ${{ parameters.repoUrl | parseRepoUrl | pick('owner') }}

    # -------------------------------------------------------------------------
    # Create Pull Request
    # -------------------------------------------------------------------------
    - id: create-pr
      name: Create Pull Request
      action: publish:github:pull-request
      input:
        repoUrl: ${{ parameters.repoUrl }}
        branchName: add-cicd-pipelines
        title: "feat: Add standardized CI/CD pipelines"
        description: |
          ## üöÄ CI/CD Pipeline Addition
          
          This PR adds standardized CI/CD pipelines to the repository using the 
          Three Horizons H1 Foundation template.
          
          ### Features Added
          
          **CI Workflows:**
          - ‚úÖ Build workflow (${{ parameters.language }})
          ${{ parameters.enableTest ? '- ‚úÖ Test workflow with coverage' : '' }}
          ${{ parameters.enableLint ? '- ‚úÖ Linting and code quality' : '' }}
          
          **Security:**
          ${{ parameters.enableSecurity ? '- ‚úÖ GitHub Advanced Security (CodeQL)' : '- ‚è≠Ô∏è Security scanning skipped' }}
          ${{ parameters.enableDependencyReview ? '- ‚úÖ Dependency review on PRs' : '' }}
          - ‚úÖ Dependabot configuration
          
          **Deployment:**
          ${{ parameters.enableDeploy ? '- ‚úÖ Deployment to ' + parameters.deploymentTarget : '- ‚è≠Ô∏è Deployment skipped' }}
          ${{ parameters.enableDeploy ? '- üì¶ Environments: ' + parameters.environments.join(', ') : '' }}
          ${{ parameters.requireApproval ? '- üîê Production approval required' : '' }}
          
          ### Next Steps
          
          1. Review the workflow files in `.github/workflows/`
          2. Update any environment-specific variables
          3. Configure repository secrets if needed
          4. Merge this PR to enable CI/CD
          
          ---
          *Generated by RHDH Three Horizons Accelerator*
        sourcePath: ./repo
        targetPath: .

  # ===========================================================================
  # OUTPUT
  # ===========================================================================
  
  output:
    links:
      - title: Pull Request
        url: ${{ steps['create-pr'].output.remoteUrl }}
      - title: Repository
        url: https://github.com/${{ parameters.repoUrl | parseRepoUrl | pick('owner') }}/${{ parameters.repoUrl | parseRepoUrl | pick('repo') }}
    text:
      - title: Next Steps
        content: |
          ## ‚úÖ CI/CD Pipeline Created!
          
          A pull request has been created to add CI/CD pipelines to your repository.
          
          **Review and merge the PR to enable:**
          - Automated builds on every push
          - Test execution with coverage reports
          - Security scanning with GHAS
          - Automated deployments to ${{ parameters.deploymentTarget }}
          
          **After merging:**
          1. Check the Actions tab for workflow runs
          2. Configure any missing secrets
          3. Enable branch protection rules

---
# =============================================================================
# SKELETON FILES - CI WORKFLOW
# =============================================================================
# skeleton/workflows/ci/ci.yaml

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ci-{{"${{ github.ref }}"}}
  cancel-in-progress: true

env:
  LANGUAGE_VERSION: ${{ values.languageVersion }}

jobs:
  {%- if values.enableBuild or values.enableTest or values.enableLint %}
  
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      {%- if values.language == 'python' %}
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: {{"${{ env.LANGUAGE_VERSION }}"}}
          cache: '{%- if values.packageManager == 'poetry' %}poetry{%- else %}pip{%- endif %}'

      {%- if values.packageManager == 'poetry' %}
      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        run: poetry install --no-interaction
      {%- else %}
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt || true
      {%- endif %}

      {%- if values.enableLint %}
      - name: Lint
        run: |
          {%- if values.packageManager == 'poetry' %}
          poetry run ruff check .
          poetry run ruff format --check .
          {%- else %}
          pip install ruff
          ruff check .
          ruff format --check .
          {%- endif %}
      {%- endif %}

      {%- if values.enableTest %}
      - name: Test
        run: |
          {%- if values.testCommand %}
          ${{ values.testCommand }}
          {%- elif values.packageManager == 'poetry' %}
          poetry run pytest --cov=src --cov-report=xml --cov-report=html
          {%- else %}
          pytest --cov=src --cov-report=xml --cov-report=html
          {%- endif %}

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
      {%- endif %}
      {%- endif %}

      {%- if values.language == 'nodejs' or values.language == 'typescript' %}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: {{"${{ env.LANGUAGE_VERSION }}"}}
          cache: '${{ values.packageManager }}'

      - name: Install dependencies
        run: |
          {%- if values.packageManager == 'yarn' %}
          yarn install --frozen-lockfile
          {%- elif values.packageManager == 'pnpm' %}
          corepack enable
          pnpm install --frozen-lockfile
          {%- else %}
          npm ci
          {%- endif %}

      {%- if values.enableLint %}
      - name: Lint
        run: |
          {%- if values.packageManager == 'yarn' %}
          yarn lint
          {%- elif values.packageManager == 'pnpm' %}
          pnpm lint
          {%- else %}
          npm run lint
          {%- endif %}
      {%- endif %}

      {%- if values.enableTest %}
      - name: Test
        run: |
          {%- if values.testCommand %}
          ${{ values.testCommand }}
          {%- elif values.packageManager == 'yarn' %}
          yarn test --coverage
          {%- elif values.packageManager == 'pnpm' %}
          pnpm test --coverage
          {%- else %}
          npm test -- --coverage
          {%- endif %}

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: false
      {%- endif %}

      {%- if values.enableBuild %}
      - name: Build
        run: |
          {%- if values.packageManager == 'yarn' %}
          yarn build
          {%- elif values.packageManager == 'pnpm' %}
          pnpm build
          {%- else %}
          npm run build
          {%- endif %}
      {%- endif %}
      {%- endif %}

      {%- if values.language == 'java' %}
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: {{"${{ env.LANGUAGE_VERSION }}"}}
          distribution: 'temurin'
          cache: '${{ values.packageManager }}'

      {%- if values.packageManager == 'maven' %}
      - name: Build and Test
        run: mvn clean verify -B

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: target/site/jacoco/jacoco.xml
          fail_ci_if_error: false
      {%- else %}
      - name: Build and Test
        run: ./gradlew build

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: build/reports/jacoco/test/jacocoTestReport.xml
          fail_ci_if_error: false
      {%- endif %}
      {%- endif %}

      {%- if values.language == 'dotnet' %}
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: {{"${{ env.LANGUAGE_VERSION }}"}}

      - name: Restore
        run: dotnet restore

      {%- if values.enableBuild %}
      - name: Build
        run: dotnet build --no-restore -c Release
      {%- endif %}

      {%- if values.enableTest %}
      - name: Test
        run: dotnet test --no-build -c Release --collect:"XPlat Code Coverage"

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: false
      {%- endif %}
      {%- endif %}

      {%- if values.language == 'go' %}
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: {{"${{ env.LANGUAGE_VERSION }}"}}
          cache: true

      {%- if values.enableLint %}
      - name: Lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
      {%- endif %}

      {%- if values.enableBuild %}
      - name: Build
        run: go build -v ./...
      {%- endif %}

      {%- if values.enableTest %}
      - name: Test
        run: go test -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          fail_ci_if_error: false
      {%- endif %}
      {%- endif %}
  {%- endif %}
