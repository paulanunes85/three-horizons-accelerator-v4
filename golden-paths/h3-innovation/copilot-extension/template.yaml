apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: copilot-extension
  title: GitHub Copilot Extension
  description: |
    Creates a GitHub Copilot Extension (Agent) with:
    - Custom agent implementation
    - Skillset configuration
    - Azure integration for data retrieval
    - OAuth authentication
    - Deployment to GitHub Marketplace
  tags:
    - copilot
    - ai
    - github
    - extension
    - h3-innovation
spec:
  owner: platform-team
  type: service
  
  parameters:
    - title: Extension Configuration
      required:
        - name
        - owner
        - display_name
      properties:
        name:
          title: Extension Name
          type: string
          description: Unique name for your Copilot extension (lowercase, hyphens)
          pattern: '^[a-z0-9-]+$'
          ui:autofocus: true
        display_name:
          title: Display Name
          type: string
          description: Human-readable name shown in Copilot
        owner:
          title: Owner Team
          type: string
          ui:field: OwnerPicker
        description:
          title: Description
          type: string
          description: What does this extension help users with?
          ui:widget: textarea
          
    - title: Agent Capabilities
      properties:
        agent_type:
          title: Agent Type
          type: string
          enum:
            - skillset
            - full_agent
          enumNames:
            - Skillset (Tools only)
            - Full Agent (Custom logic)
          default: skillset
        skills:
          title: Skills to Include
          type: array
          description: Select capabilities for your extension
          items:
            type: string
            enum:
              - code_search
              - documentation_search
              - database_query
              - api_integration
              - azure_resources
              - ticket_lookup
              - deployment_status
        custom_instructions:
          title: Custom Instructions
          type: string
          description: System prompt for the agent
          ui:widget: textarea
          
    - title: Data Sources
      properties:
        enable_azure_search:
          title: Enable Azure AI Search
          type: boolean
          default: false
          description: Search internal documentation and knowledge bases
        enable_github_search:
          title: Enable GitHub Code Search
          type: boolean
          default: true
          description: Search repositories and code
        enable_database:
          title: Enable Database Queries
          type: boolean
          default: false
          description: Query internal databases
        data_sources:
          title: Additional Data Sources
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
                enum: [rest_api, graphql, azure_function]
              endpoint:
                type: string
                
    - title: Infrastructure
      required:
        - environment
      properties:
        environment:
          title: Environment
          type: string
          enum:
            - dev
            - staging
            - prod
        hosting:
          title: Hosting Platform
          type: string
          enum:
            - azure_functions
            - azure_container_apps
            - github_actions
          default: azure_functions
        azure_region:
          title: Azure Region
          type: string
          enum:
            - brazilsouth
            - eastus
            - westeurope
          default: eastus
          
  steps:
    - id: fetch-template
      name: Fetch Copilot Extension Template
      action: fetch:template
      input:
        url: ./skeleton
        values:
          name: ${{ parameters.name }}
          display_name: ${{ parameters.display_name }}
          owner: ${{ parameters.owner }}
          description: ${{ parameters.description }}
          agent_type: ${{ parameters.agent_type }}
          custom_instructions: ${{ parameters.custom_instructions }}
          skills: ${{ parameters.skills }}
          enable_azure_search: ${{ parameters.enable_azure_search }}
          enable_github_search: ${{ parameters.enable_github_search }}
          enable_database: ${{ parameters.enable_database }}
          environment: ${{ parameters.environment }}
          azure_region: ${{ parameters.azure_region }}

    - id: publish-github
      name: Publish to GitHub
      action: publish:github
      input:
        allowedHosts: ['github.com']
        repoUrl: github.com?owner=${{ parameters.owner }}&repo=${{ parameters.name }}
        description: GitHub Copilot Extension - ${{ parameters.display_name }}
        defaultBranch: main
        repoVisibility: private
        
    - id: register-catalog
      name: Register in Catalog
      action: catalog:register
      input:
        repoContentsUrl: ${{ steps['publish-github'].output.repoContentsUrl }}
        catalogInfoPath: /catalog-info.yaml
        
  output:
    links:
      - title: Repository
        url: ${{ steps['publish-github'].output.remoteUrl }}
      - title: GitHub App Settings
        url: https://github.com/organizations/${{ parameters.owner }}/settings/apps
      - title: Open in Catalog
        icon: catalog
        entityRef: ${{ steps['register-catalog'].output.entityRef }}
