{
  "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/main/.schema/devbox.schema.json",
  "name": "${{ values.name | default('api-microservice') }}",
  "packages": [
    "python@3.12",
    "poetry@latest",
    "git@latest", 
    "curl@latest",
    "jq@latest",
    "yq@latest",
    "gh@latest",
    "azure-cli@latest",
    "kubectl@latest",
    "kubernetes-helm@latest",
    "kustomize@latest",
    "docker@latest",
    "docker-compose@latest",
    "postgresql@latest",
    "redis@latest"
  ],
  "env": {
    "PROJECT_NAME": "${{ values.name | default('api-microservice') }}",
    "ENVIRONMENT": "development",
    "PYTHONDONTWRITEBYTECODE": "1",
    "PYTHONUNBUFFERED": "1",
    "DATABASE_URL": "postgresql://postgres:postgres@localhost:5432/${{ values.databaseName | default('app') }}",
    "REDIS_URL": "redis://localhost:6379/0"
  },
  "shell": {
    "init_hook": [
      "echo 'ðŸš€ Three Horizons - H2 API Microservice'",
      "echo 'Project: ${{ values.name }}'",
      "echo ''",
      "if [ -f .venv/bin/activate ]; then source .venv/bin/activate; fi",
      "if [ -f .env ]; then set -a; source .env; set +a; fi"
    ],
    "scripts": {
      "setup": [
        "python -m venv .venv",
        "source .venv/bin/activate",
        "pip install --upgrade pip",
        "pip install -r requirements.txt",
        "if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi",
        "pre-commit install",
        "echo 'âœ… Python environment ready!'"
      ],
      "dev": [
        "docker-compose up -d db redis",
        "source .venv/bin/activate",
        "uvicorn src.main:app --reload --host 0.0.0.0 --port 8000"
      ],
      "test": [
        "source .venv/bin/activate",
        "pytest -v --cov=src --cov-report=term-missing"
      ],
      "lint": [
        "source .venv/bin/activate",
        "ruff check src tests",
        "black --check src tests",
        "mypy src"
      ],
      "format": [
        "source .venv/bin/activate",
        "ruff check --fix src tests",
        "black src tests",
        "isort src tests"
      ],
      "build": [
        "docker build -t $PROJECT_NAME:dev ."
      ],
      "db-up": [
        "docker-compose up -d db",
        "echo 'PostgreSQL started on port 5432'"
      ],
      "db-migrate": [
        "source .venv/bin/activate",
        "alembic upgrade head"
      ],
      "db-revision": [
        "source .venv/bin/activate",
        "read -p 'Migration message: ' msg",
        "alembic revision --autogenerate -m \"$msg\""
      ],
      "redis-up": [
        "docker-compose up -d redis",
        "echo 'Redis started on port 6379'"
      ],
      "deploy-dev": [
        "kubectl apply -k deploy/kubernetes/overlays/dev"
      ],
      "logs": [
        "docker-compose logs -f"
      ],
      "stop": [
        "docker-compose down"
      ]
    }
  }
}
