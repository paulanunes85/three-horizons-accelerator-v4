apiVersion: scaffolder.backstage.io/v1beta3
kind: Template
metadata:
  name: ado-to-github-migration
  title: Azure DevOps to GitHub Migration
  description: |
    Complete migration toolkit from Azure DevOps to GitHub following the official
    Microsoft Migration Playbook. Supports repository migration, pipeline conversion,
    mannequin management, and hybrid Azure DevOps/GitHub integration.
  tags:
    - migration
    - azure-devops
    - github
    - h2-enhancement
    - recommended
  annotations:
    backstage.io/techdocs-ref: dir:.
  links:
    - url: https://devblogs.microsoft.com/all-things-azure/azure-devops-to-github-migration-playbook-unlocking-agentic-devops/
      title: Microsoft Migration Playbook
      icon: docs
spec:
  owner: platform-engineering
  type: migration

  parameters:
    - title: Migration Configuration
      required:
        - adoOrganization
        - adoProject
        - githubOrganization
      properties:
        adoOrganization:
          title: Azure DevOps Organization
          type: string
          description: Your Azure DevOps organization name (e.g., myorg from dev.azure.com/myorg)
          ui:autofocus: true

        adoProject:
          title: Azure DevOps Project
          type: string
          description: The project to migrate

        githubOrganization:
          title: GitHub Organization
          type: string
          description: Target GitHub organization

        migrationMode:
          title: Migration Mode
          type: string
          default: hybrid
          enum:
            - full
            - hybrid
            - repos-only
          enumNames:
            - Full Migration (move everything to GitHub)
            - Hybrid (code on GitHub, keep Azure Boards)
            - Repositories Only
          description: |
            Hybrid mode keeps Azure Boards for project management while moving code to GitHub.
            This is the recommended approach per Microsoft guidance.

    - title: Repository Options
      properties:
        repositorySelection:
          title: Repositories to Migrate
          type: string
          default: all
          enum:
            - all
            - selected
          enumNames:
            - All repositories in project
            - Select specific repositories

        selectedRepositories:
          title: Repository Names (comma-separated)
          type: string
          description: Only if 'Select specific repositories' is chosen
          ui:widget: textarea

        namingConvention:
          title: Repository Naming Convention
          type: string
          default: kebab-case
          enum:
            - kebab-case
            - preserve
            - prefix
          enumNames:
            - Convert to kebab-case (recommended)
            - Preserve original names
            - Add project prefix

        repositoryVisibility:
          title: Repository Visibility
          type: string
          default: private
          enum:
            - private
            - internal
            - public
          enumNames:
            - Private
            - Internal (Enterprise only)
            - Public

        lockAdoRepos:
          title: Lock ADO Repositories
          type: boolean
          default: true
          description: Set source repositories to read-only after migration

        disableAdoRepos:
          title: Disable ADO Repositories
          type: boolean
          default: false
          description: Disable ADO repositories post-migration (more restrictive than lock)

    - title: Pipeline Options
      properties:
        migratePipelines:
          title: Migrate Pipelines
          type: boolean
          default: true
          description: Convert Azure Pipelines to GitHub Actions

        rewirePipelines:
          title: Rewire Azure Pipelines
          type: boolean
          default: true
          description: |
            Reconfigure Azure Pipelines to use GitHub as source.
            Requires Azure Pipelines GitHub App to be installed.

        pipelineConversionMode:
          title: Pipeline Conversion Mode
          type: string
          default: auto
          enum:
            - auto
            - manual
            - hybrid
          enumNames:
            - Automatic conversion
            - Generate templates for manual review
            - Keep Azure Pipelines + add GitHub Actions

    - title: Team & Security Options
      properties:
        createTeams:
          title: Create GitHub Teams
          type: boolean
          default: true
          description: Create GitHub teams based on ADO team structure

        enableGHAS:
          title: Enable GitHub Advanced Security
          type: boolean
          default: true
          description: Enable secret scanning, code scanning, and Dependabot

        enableBranchProtection:
          title: Enable Branch Protection
          type: boolean
          default: true

        requiredReviewers:
          title: Required Reviewers
          type: integer
          default: 1
          minimum: 0
          maximum: 6

    - title: Additional Options
      properties:
        migrateWorkItems:
          title: Migrate Work Items
          type: boolean
          default: false
          description: Migrate work items to GitHub Issues (not recommended for hybrid mode)

        migrateWiki:
          title: Migrate Wiki
          type: boolean
          default: false
          description: Migrate Azure DevOps Wiki to GitHub Wiki

        migrateArtifacts:
          title: Migrate Artifacts
          type: boolean
          default: false
          description: Migrate Azure Artifacts to GitHub Packages

        dryRun:
          title: Dry Run Mode
          type: boolean
          default: true
          description: Preview migration without making changes (recommended for first run)

  steps:
    # ==========================================================================
    # PHASE 1: PREREQUISITES CHECK
    # ==========================================================================
    - id: check-prerequisites
      name: Check Prerequisites
      action: run:script
      input:
        script: |
          #!/bin/bash
          set -euo pipefail

          echo "=== Phase 1: Prerequisites Check ==="
          echo ""

          MISSING=()

          # Check GitHub CLI
          if ! command -v gh &>/dev/null; then
            MISSING+=("gh (GitHub CLI) - Install: https://cli.github.com/")
          else
            echo "‚úÖ GitHub CLI: $(gh --version | head -1)"
          fi

          # Check Azure CLI
          if ! command -v az &>/dev/null; then
            MISSING+=("az (Azure CLI) - Install: https://docs.microsoft.com/cli/azure/install-azure-cli")
          else
            echo "‚úÖ Azure CLI: $(az --version | head -1)"
          fi

          # Check git
          if ! command -v git &>/dev/null; then
            MISSING+=("git")
          else
            echo "‚úÖ Git: $(git --version)"
          fi

          # Check jq
          if ! command -v jq &>/dev/null; then
            MISSING+=("jq - Install: brew install jq or apt install jq")
          else
            echo "‚úÖ jq: $(jq --version)"
          fi

          # Check ado2gh extension
          if ! gh extension list 2>/dev/null | grep -q "ado2gh"; then
            echo ""
            echo "‚ö†Ô∏è  Installing gh-ado2gh extension..."
            gh extension install github/gh-ado2gh
            echo "‚úÖ gh-ado2gh extension installed"
          else
            echo "‚úÖ gh-ado2gh extension: installed"
          fi

          # Check authentication
          echo ""
          echo "=== Authentication Status ==="

          if gh auth status &>/dev/null; then
            echo "‚úÖ GitHub CLI authenticated"
          else
            MISSING+=("GitHub CLI not authenticated - Run: gh auth login")
          fi

          if [[ -z "${ADO_PAT:-}" ]]; then
            echo "‚ö†Ô∏è  ADO_PAT environment variable not set"
            echo "   Set with: export ADO_PAT='your-pat-token'"
            MISSING+=("ADO_PAT environment variable")
          else
            echo "‚úÖ ADO_PAT configured"
          fi

          if [[ -z "${GH_PAT:-}" ]]; then
            echo "‚ö†Ô∏è  GH_PAT environment variable not set (optional if using gh auth)"
          else
            echo "‚úÖ GH_PAT configured"
          fi

          # Report missing
          if [[ ${#MISSING[@]} -gt 0 ]]; then
            echo ""
            echo "‚ùå Missing prerequisites:"
            for item in "${MISSING[@]}"; do
              echo "   - $item"
            done
            exit 1
          fi

          echo ""
          echo "‚úÖ All prerequisites satisfied"

    # ==========================================================================
    # PHASE 2: AZURE PIPELINES APP INSTALLATION CHECK
    # ==========================================================================
    - id: check-azure-pipelines-app
      name: Check Azure Pipelines GitHub App
      action: run:script
      input:
        script: |
          #!/bin/bash
          echo "=== Phase 2: Azure Pipelines App Check ==="
          echo ""

          if [[ "${{ parameters.rewirePipelines }}" == "true" ]]; then
            echo "‚ö†Ô∏è  IMPORTANT: Azure Pipelines GitHub App Required"
            echo ""
            echo "Before proceeding, ensure the Azure Pipelines app is installed:"
            echo ""
            echo "1. Go to: https://github.com/marketplace/azure-pipelines"
            echo "2. Click 'Install it for free'"
            echo "3. Select organization: ${{ parameters.githubOrganization }}"
            echo "4. Grant access to repositories (all or selected)"
            echo ""
            echo "This enables automatic pipeline reconfiguration to use GitHub as source."
            echo ""

            # Check if app is installed (best effort)
            if gh api "/orgs/${{ parameters.githubOrganization }}/installations" 2>/dev/null | grep -q "Azure Pipelines"; then
              echo "‚úÖ Azure Pipelines app appears to be installed"
            else
              echo "‚ö†Ô∏è  Could not verify Azure Pipelines app installation"
              echo "   Please verify manually before continuing with pipeline rewiring"
            fi
          else
            echo "‚ÑπÔ∏è  Pipeline rewiring disabled - Azure Pipelines app not required"
          fi

    # ==========================================================================
    # PHASE 3: INVENTORY REPORT
    # ==========================================================================
    - id: generate-inventory
      name: Generate Inventory Report
      action: run:script
      input:
        script: |
          #!/bin/bash
          set -euo pipefail

          echo "=== Phase 3: Organization Inventory ==="
          echo ""

          INVENTORY_DIR="${GITHUB_WORKSPACE:-/tmp}/migration-inventory"
          mkdir -p "$INVENTORY_DIR"

          echo "Generating inventory report for: ${{ parameters.adoOrganization }}"
          echo ""

          # Generate inventory using ado2gh
          gh ado2gh inventory-report \
            --ado-org "${{ parameters.adoOrganization }}" \
            --output-path "$INVENTORY_DIR" \
            2>&1 || {
              echo "‚ö†Ô∏è  inventory-report command failed, using manual inventory"

              # Fallback to manual inventory
              echo "Generating manual inventory..."

              # List repositories
              az repos list \
                --org "https://dev.azure.com/${{ parameters.adoOrganization }}" \
                --project "${{ parameters.adoProject }}" \
                --query "[].{name:name,size:size,defaultBranch:defaultBranch}" \
                -o json > "$INVENTORY_DIR/repos.json"

              # List pipelines
              az pipelines list \
                --org "https://dev.azure.com/${{ parameters.adoOrganization }}" \
                --project "${{ parameters.adoProject }}" \
                --query "[].{name:name,path:path,type:configuration.type}" \
                -o json > "$INVENTORY_DIR/pipelines.json"

              # List teams
              az devops team list \
                --org "https://dev.azure.com/${{ parameters.adoOrganization }}" \
                --project "${{ parameters.adoProject }}" \
                --query "[].{name:name,description:description}" \
                -o json > "$INVENTORY_DIR/teams.json" 2>/dev/null || echo "[]" > "$INVENTORY_DIR/teams.json"
            }

          echo ""
          echo "=== Inventory Summary ==="
          echo ""

          # Display inventory
          if [[ -f "$INVENTORY_DIR/repos.csv" ]]; then
            echo "Repositories: $(wc -l < "$INVENTORY_DIR/repos.csv") found"
            echo "Pipelines: $(wc -l < "$INVENTORY_DIR/pipelines.csv") found"
            echo "Teams: $(wc -l < "$INVENTORY_DIR/team-projects.csv" 2>/dev/null || echo 0) found"
          else
            echo "Repositories: $(jq length "$INVENTORY_DIR/repos.json") found"
            echo "Pipelines: $(jq length "$INVENTORY_DIR/pipelines.json") found"
            echo "Teams: $(jq length "$INVENTORY_DIR/teams.json") found"
          fi

          echo ""
          echo "üìÅ Inventory saved to: $INVENTORY_DIR"
          echo ""

          # Store for later steps
          echo "INVENTORY_DIR=$INVENTORY_DIR" >> "$GITHUB_ENV" 2>/dev/null || true

    # ==========================================================================
    # PHASE 4: GENERATE MIGRATION SCRIPT
    # ==========================================================================
    - id: generate-migration-script
      name: Generate Migration Script
      action: run:script
      input:
        script: |
          #!/bin/bash
          set -euo pipefail

          echo "=== Phase 4: Generate Migration Script ==="
          echo ""

          SCRIPT_DIR="${GITHUB_WORKSPACE:-/tmp}/migration-scripts"
          mkdir -p "$SCRIPT_DIR"

          # Build command options
          CMD_OPTS=""

          # Lock ADO repos
          if [[ "${{ parameters.lockAdoRepos }}" == "true" ]]; then
            CMD_OPTS="$CMD_OPTS --lock-ado-repo"
          fi

          # Disable ADO repos
          if [[ "${{ parameters.disableAdoRepos }}" == "true" ]]; then
            CMD_OPTS="$CMD_OPTS --disable-ado-repos"
          fi

          # Create teams
          if [[ "${{ parameters.createTeams }}" == "true" ]]; then
            CMD_OPTS="$CMD_OPTS --create-teams"
          fi

          # Rewire pipelines
          if [[ "${{ parameters.rewirePipelines }}" == "true" ]]; then
            CMD_OPTS="$CMD_OPTS --rewire-pipelines"
          fi

          # Repository selection
          if [[ "${{ parameters.repositorySelection }}" == "selected" ]] && [[ -n "${{ parameters.selectedRepositories }}" ]]; then
            # Create repo list CSV
            echo "repo" > "$SCRIPT_DIR/repo-list.csv"
            echo "${{ parameters.selectedRepositories }}" | tr ',' '\n' | sed 's/^ *//;s/ *$//' >> "$SCRIPT_DIR/repo-list.csv"
            CMD_OPTS="$CMD_OPTS --repo-list $SCRIPT_DIR/repo-list.csv"
          else
            CMD_OPTS="$CMD_OPTS --all"
          fi

          echo "Generating migration script with options:"
          echo "  ADO Org: ${{ parameters.adoOrganization }}"
          echo "  ADO Project: ${{ parameters.adoProject }}"
          echo "  GitHub Org: ${{ parameters.githubOrganization }}"
          echo "  Options: $CMD_OPTS"
          echo ""

          # Generate script
          gh ado2gh generate-script \
            --ado-org "${{ parameters.adoOrganization }}" \
            --ado-team-project "${{ parameters.adoProject }}" \
            --github-org "${{ parameters.githubOrganization }}" \
            --output "$SCRIPT_DIR/migrate.ps1" \
            --sequential \
            $CMD_OPTS \
            2>&1 || {
              echo "‚ö†Ô∏è  Script generation with ado2gh failed"
              echo "   Creating fallback bash migration script..."

              # Create fallback script
              cat > "$SCRIPT_DIR/migrate.sh" << 'FALLBACK_SCRIPT'
          #!/bin/bash
          # Fallback migration script
          set -euo pipefail

          ADO_ORG="${ADO_ORG:-${{ parameters.adoOrganization }}}"
          ADO_PROJECT="${ADO_PROJECT:-${{ parameters.adoProject }}}"
          GH_ORG="${GH_ORG:-${{ parameters.githubOrganization }}}"

          echo "=== Repository Migration ==="

          # Get repository list
          REPOS=$(az repos list \
            --org "https://dev.azure.com/$ADO_ORG" \
            --project "$ADO_PROJECT" \
            --query "[].name" -o tsv)

          for REPO in $REPOS; do
            echo ""
            echo "Migrating: $REPO"

            # Convert to kebab-case
            GH_REPO=$(echo "$REPO" | tr '[:upper:]' '[:lower:]' | tr ' _' '-')

            # Clone with mirror
            TEMP_DIR=$(mktemp -d)
            git clone --mirror "https://dev.azure.com/$ADO_ORG/$ADO_PROJECT/_git/$REPO" "$TEMP_DIR/$REPO"

            # Create GitHub repo
            gh repo create "$GH_ORG/$GH_REPO" --private --description "Migrated from ADO: $ADO_PROJECT/$REPO" 2>/dev/null || true

            # Push to GitHub
            cd "$TEMP_DIR/$REPO"
            git push --mirror "https://github.com/$GH_ORG/$GH_REPO.git"

            echo "‚úÖ $REPO -> $GH_ORG/$GH_REPO"

            # Cleanup
            rm -rf "$TEMP_DIR"
          done

          echo ""
          echo "=== Migration Complete ==="
          FALLBACK_SCRIPT
              chmod +x "$SCRIPT_DIR/migrate.sh"
            }

          echo ""
          echo "üìÅ Migration script saved to: $SCRIPT_DIR"
          echo ""

          # Display script preview
          echo "=== Script Preview ==="
          if [[ -f "$SCRIPT_DIR/migrate.ps1" ]]; then
            head -50 "$SCRIPT_DIR/migrate.ps1"
          else
            head -50 "$SCRIPT_DIR/migrate.sh"
          fi

    # ==========================================================================
    # PHASE 5: EXECUTE MIGRATION
    # ==========================================================================
    - id: execute-migration
      name: Execute Migration
      action: run:script
      input:
        script: |
          #!/bin/bash
          set -euo pipefail

          echo "=== Phase 5: Execute Migration ==="
          echo ""

          SCRIPT_DIR="${GITHUB_WORKSPACE:-/tmp}/migration-scripts"

          if [[ "${{ parameters.dryRun }}" == "true" ]]; then
            echo "üîç DRY RUN MODE - No changes will be made"
            echo ""
            echo "The following actions would be performed:"
            echo ""

            # Show what would happen
            if [[ -f "$SCRIPT_DIR/migrate.ps1" ]]; then
              grep -E "^(Migrating|Creating|Pushing|Enabling)" "$SCRIPT_DIR/migrate.ps1" 2>/dev/null || \
              echo "  - Migrate repositories from ADO to GitHub"
              echo "  - Apply naming convention: ${{ parameters.namingConvention }}"
              echo "  - Set visibility: ${{ parameters.repositoryVisibility }}"
              [[ "${{ parameters.lockAdoRepos }}" == "true" ]] && echo "  - Lock ADO repositories (read-only)"
              [[ "${{ parameters.createTeams }}" == "true" ]] && echo "  - Create GitHub teams"
              [[ "${{ parameters.rewirePipelines }}" == "true" ]] && echo "  - Rewire Azure Pipelines to GitHub"
              [[ "${{ parameters.enableGHAS }}" == "true" ]] && echo "  - Enable GitHub Advanced Security"
              [[ "${{ parameters.enableBranchProtection }}" == "true" ]] && echo "  - Enable branch protection (${{{ parameters.requiredReviewers }}} reviewers)"
            fi

            echo ""
            echo "To execute for real, set 'Dry Run Mode' to false"
            exit 0
          fi

          echo "üöÄ EXECUTING MIGRATION"
          echo ""
          echo "Estimated time: 5-10 minutes per repository"
          echo ""

          # Execute migration
          if [[ -f "$SCRIPT_DIR/migrate.ps1" ]]; then
            # PowerShell script (cross-platform)
            if command -v pwsh &>/dev/null; then
              pwsh -File "$SCRIPT_DIR/migrate.ps1"
            else
              echo "‚ö†Ô∏è  PowerShell not found, using bash fallback"
              bash "$SCRIPT_DIR/migrate.sh"
            fi
          else
            bash "$SCRIPT_DIR/migrate.sh"
          fi

          echo ""
          echo "‚úÖ Migration execution completed"

    # ==========================================================================
    # PHASE 6: POST-MIGRATION - MANNEQUIN MANAGEMENT
    # ==========================================================================
    - id: mannequin-management
      name: Mannequin Management
      action: run:script
      input:
        script: |
          #!/bin/bash
          set -euo pipefail

          echo "=== Phase 6: Mannequin Management ==="
          echo ""

          MANNEQUIN_DIR="${GITHUB_WORKSPACE:-/tmp}/mannequins"
          mkdir -p "$MANNEQUIN_DIR"

          if [[ "${{ parameters.dryRun }}" == "true" ]]; then
            echo "üîç DRY RUN - Skipping mannequin management"
            exit 0
          fi

          echo "Mannequins are placeholder accounts for users who don't have"
          echo "matching GitHub accounts. After migration, you should reclaim"
          echo "these to properly attribute commits."
          echo ""

          # Generate mannequin CSV
          echo "Generating mannequin list..."
          gh ado2gh generate-mannequin-csv \
            --github-org "${{ parameters.githubOrganization }}" \
            --output "$MANNEQUIN_DIR/mannequins.csv" \
            2>&1 || {
              echo "‚ö†Ô∏è  Could not generate mannequin list"
              echo "   This may mean no mannequins were created (good!)"
              echo "   Or the migration hasn't completed yet"
              exit 0
            }

          # Check if mannequins exist
          MANNEQUIN_COUNT=$(wc -l < "$MANNEQUIN_DIR/mannequins.csv" 2>/dev/null || echo 0)
          MANNEQUIN_COUNT=$((MANNEQUIN_COUNT - 1))  # Subtract header

          if [[ $MANNEQUIN_COUNT -le 0 ]]; then
            echo "‚úÖ No mannequins found - all users mapped correctly!"
            exit 0
          fi

          echo "Found $MANNEQUIN_COUNT mannequin(s)"
          echo ""
          echo "=== Mannequin List ==="
          cat "$MANNEQUIN_DIR/mannequins.csv"
          echo ""

          # Create mapping template
          cat > "$MANNEQUIN_DIR/mannequin-mapping.csv" << 'MAPPING_TEMPLATE'
          # Mannequin Mapping Template
          # Format: mannequin-user,github-username
          #
          # Instructions:
          # 1. Fill in the github-username column with the correct GitHub username
          # 2. Run: gh ado2gh reclaim-mannequin --github-org ORG --csv mannequin-mapping.csv
          #
          MAPPING_TEMPLATE

          tail -n +2 "$MANNEQUIN_DIR/mannequins.csv" | while read -r line; do
            mannequin=$(echo "$line" | cut -d',' -f1)
            echo "$mannequin," >> "$MANNEQUIN_DIR/mannequin-mapping.csv"
          done

          echo ""
          echo "üìÅ Mannequin files saved to: $MANNEQUIN_DIR"
          echo ""
          echo "To reclaim mannequins:"
          echo "1. Edit $MANNEQUIN_DIR/mannequin-mapping.csv"
          echo "2. Add GitHub usernames for each mannequin"
          echo "3. Run: gh ado2gh reclaim-mannequin \\"
          echo "     --github-org ${{ parameters.githubOrganization }} \\"
          echo "     --csv $MANNEQUIN_DIR/mannequin-mapping.csv"

    # ==========================================================================
    # PHASE 7: POST-MIGRATION - SECURITY & CONFIGURATION
    # ==========================================================================
    - id: post-migration-config
      name: Post-Migration Configuration
      action: run:script
      input:
        script: |
          #!/bin/bash
          set -euo pipefail

          echo "=== Phase 7: Post-Migration Configuration ==="
          echo ""

          if [[ "${{ parameters.dryRun }}" == "true" ]]; then
            echo "üîç DRY RUN - Skipping post-migration configuration"
            exit 0
          fi

          GH_ORG="${{ parameters.githubOrganization }}"

          # Get list of migrated repos
          REPOS=$(gh repo list "$GH_ORG" --json name -q '.[].name' 2>/dev/null || echo "")

          if [[ -z "$REPOS" ]]; then
            echo "‚ö†Ô∏è  No repositories found in $GH_ORG"
            exit 0
          fi

          for REPO in $REPOS; do
            echo ""
            echo "=== Configuring: $GH_ORG/$REPO ==="

            # Enable GHAS
            if [[ "${{ parameters.enableGHAS }}" == "true" ]]; then
              echo "  Enabling GitHub Advanced Security..."
              gh api -X PATCH "repos/$GH_ORG/$REPO" \
                -f security_and_analysis='{"advanced_security":{"status":"enabled"},"secret_scanning":{"status":"enabled"},"secret_scanning_push_protection":{"status":"enabled"}}' \
                2>/dev/null || echo "  ‚ö†Ô∏è  Could not enable GHAS (may require Enterprise)"
            fi

            # Enable Dependabot
            echo "  Enabling Dependabot..."
            gh api -X PUT "repos/$GH_ORG/$REPO/vulnerability-alerts" 2>/dev/null || true
            gh api -X PUT "repos/$GH_ORG/$REPO/automated-security-fixes" 2>/dev/null || true

            # Configure branch protection
            if [[ "${{ parameters.enableBranchProtection }}" == "true" ]]; then
              echo "  Configuring branch protection..."

              # Get default branch
              DEFAULT_BRANCH=$(gh api "repos/$GH_ORG/$REPO" -q '.default_branch' 2>/dev/null || echo "main")

              gh api -X PUT "repos/$GH_ORG/$REPO/branches/$DEFAULT_BRANCH/protection" \
                -H "Accept: application/vnd.github+json" \
                -f required_status_checks='{"strict":true,"contexts":[]}' \
                -f enforce_admins=false \
                -f required_pull_request_reviews='{"required_approving_review_count":${{ parameters.requiredReviewers }},"dismiss_stale_reviews":true}' \
                -f restrictions=null \
                -f allow_force_pushes=false \
                -f allow_deletions=false \
                2>/dev/null || echo "  ‚ö†Ô∏è  Could not set branch protection"
            fi

            echo "  ‚úÖ Configuration complete"
          done

          echo ""
          echo "‚úÖ Post-migration configuration completed"

    # ==========================================================================
    # PHASE 8: VALIDATION
    # ==========================================================================
    - id: validation
      name: Migration Validation
      action: run:script
      input:
        script: |
          #!/bin/bash
          set -euo pipefail

          echo "=== Phase 8: Migration Validation ==="
          echo ""

          GH_ORG="${{ parameters.githubOrganization }}"
          VALIDATION_PASSED=true

          echo "Running validation checklist..."
          echo ""

          # 1. Check repositories accessible
          echo "1Ô∏è‚É£ Checking repository accessibility..."
          REPO_COUNT=$(gh repo list "$GH_ORG" --json name -q 'length' 2>/dev/null || echo 0)
          if [[ $REPO_COUNT -gt 0 ]]; then
            echo "   ‚úÖ $REPO_COUNT repositories accessible on GitHub"
          else
            echo "   ‚ùå No repositories found"
            VALIDATION_PASSED=false
          fi

          # 2. Check branches and tags
          echo ""
          echo "2Ô∏è‚É£ Checking branches and tags..."
          for REPO in $(gh repo list "$GH_ORG" --json name -q '.[].name' 2>/dev/null | head -5); do
            BRANCH_COUNT=$(gh api "repos/$GH_ORG/$REPO/branches" -q 'length' 2>/dev/null || echo 0)
            TAG_COUNT=$(gh api "repos/$GH_ORG/$REPO/tags" -q 'length' 2>/dev/null || echo 0)
            echo "   $REPO: $BRANCH_COUNT branches, $TAG_COUNT tags"
          done
          echo "   ‚úÖ Branches and tags check complete"

          # 3. Check pipelines (if rewired)
          if [[ "${{ parameters.rewirePipelines }}" == "true" ]]; then
            echo ""
            echo "3Ô∏è‚É£ Checking Azure Pipelines connection..."
            echo "   ‚ÑπÔ∏è  Verify in Azure DevOps that pipelines are using GitHub source"
            echo "   ‚úÖ Pipeline rewiring requested (verify manually)"
          fi

          # 4. Check mannequins
          echo ""
          echo "4Ô∏è‚É£ Checking mannequin status..."
          MANNEQUIN_FILE="${GITHUB_WORKSPACE:-/tmp}/mannequins/mannequins.csv"
          if [[ -f "$MANNEQUIN_FILE" ]]; then
            MANNEQUIN_COUNT=$(($(wc -l < "$MANNEQUIN_FILE") - 1))
            if [[ $MANNEQUIN_COUNT -gt 0 ]]; then
              echo "   ‚ö†Ô∏è  $MANNEQUIN_COUNT mannequins need to be reclaimed"
            else
              echo "   ‚úÖ No mannequins to reclaim"
            fi
          else
            echo "   ‚úÖ Mannequin check skipped (dry run or no mannequins)"
          fi

          # 5. Check branch protection
          if [[ "${{ parameters.enableBranchProtection }}" == "true" ]]; then
            echo ""
            echo "5Ô∏è‚É£ Checking branch protection..."
            for REPO in $(gh repo list "$GH_ORG" --json name -q '.[].name' 2>/dev/null | head -3); do
              DEFAULT_BRANCH=$(gh api "repos/$GH_ORG/$REPO" -q '.default_branch' 2>/dev/null || echo "main")
              PROTECTED=$(gh api "repos/$GH_ORG/$REPO/branches/$DEFAULT_BRANCH/protection" 2>/dev/null && echo "yes" || echo "no")
              if [[ "$PROTECTED" == "yes" ]]; then
                echo "   ‚úÖ $REPO: Branch protection enabled"
              else
                echo "   ‚ö†Ô∏è  $REPO: Branch protection not configured"
              fi
            done
          fi

          # 6. Check GHAS
          if [[ "${{ parameters.enableGHAS }}" == "true" ]]; then
            echo ""
            echo "6Ô∏è‚É£ Checking GitHub Advanced Security..."
            for REPO in $(gh repo list "$GH_ORG" --json name -q '.[].name' 2>/dev/null | head -3); do
              GHAS_STATUS=$(gh api "repos/$GH_ORG/$REPO" -q '.security_and_analysis.advanced_security.status' 2>/dev/null || echo "unknown")
              if [[ "$GHAS_STATUS" == "enabled" ]]; then
                echo "   ‚úÖ $REPO: GHAS enabled"
              else
                echo "   ‚ö†Ô∏è  $REPO: GHAS status: $GHAS_STATUS"
              fi
            done
          fi

          # 7. Summary
          echo ""
          echo "=== Validation Summary ==="
          echo ""

          if [[ "$VALIDATION_PASSED" == "true" ]]; then
            echo "‚úÖ All critical validations passed!"
          else
            echo "‚ö†Ô∏è  Some validations failed - review above"
          fi

          echo ""
          echo "=== Next Steps for Developers ==="
          echo ""
          echo "Update local repository remotes:"
          echo ""
          echo "  cd path/to/repo"
          echo "  git remote set-url origin https://github.com/$GH_ORG/YOUR_REPO.git"
          echo "  git remote -v  # Verify"
          echo ""
          echo "=== Documentation ==="
          echo ""
          echo "- Migration Playbook: https://devblogs.microsoft.com/all-things-azure/azure-devops-to-github-migration-playbook-unlocking-agentic-devops/"
          echo "- GitHub Copilot: https://docs.github.com/copilot"
          echo "- GitHub Advanced Security: https://docs.github.com/code-security"

    # ==========================================================================
    # GENERATE REPORT
    # ==========================================================================
    - id: generate-report
      name: Generate Migration Report
      action: run:script
      input:
        script: |
          #!/bin/bash

          REPORT_FILE="${GITHUB_WORKSPACE:-/tmp}/migration-report-$(date +%Y%m%d-%H%M%S).md"

          cat > "$REPORT_FILE" << 'REPORT'
          # ADO to GitHub Migration Report

          **Date:** $(date '+%Y-%m-%d %H:%M:%S')
          **Source:** Azure DevOps - ${{ parameters.adoOrganization }}/${{ parameters.adoProject }}
          **Target:** GitHub - ${{ parameters.githubOrganization }}
          **Mode:** ${{ parameters.migrationMode }}

          ## Configuration

          | Setting | Value |
          |---------|-------|
          | Lock ADO Repos | ${{ parameters.lockAdoRepos }} |
          | Create Teams | ${{ parameters.createTeams }} |
          | Rewire Pipelines | ${{ parameters.rewirePipelines }} |
          | Enable GHAS | ${{ parameters.enableGHAS }} |
          | Branch Protection | ${{ parameters.enableBranchProtection }} |
          | Required Reviewers | ${{ parameters.requiredReviewers }} |

          ## Validation Checklist

          - [ ] All repositories accessible on GitHub
          - [ ] Branches and tags present
          - [ ] Azure DevOps pipelines functional (if hybrid)
          - [ ] Mannequins reclaimed
          - [ ] Teams updated local configurations
          - [ ] Branch protections configured
          - [ ] Documentation updated

          ## Next Steps

          1. **Verify CI/CD:** Check GitHub Actions tab for workflow runs
          2. **Review Security:** Check Security tab for GHAS findings
          3. **Reclaim Mannequins:** Complete user mapping if needed
          4. **Communicate:** Notify team of migration completion
          5. **Archive:** Consider archiving ADO repos after validation period

          ## Resources

          - [Microsoft Migration Playbook](https://devblogs.microsoft.com/all-things-azure/azure-devops-to-github-migration-playbook-unlocking-agentic-devops/)
          - [GitHub Copilot Documentation](https://docs.github.com/copilot)
          - [GitHub Advanced Security](https://docs.github.com/code-security)

          ---
          *Generated by Three Horizons Accelerator - ADO to GitHub Migration Golden Path*
          REPORT

          echo "üìÑ Migration report saved to: $REPORT_FILE"
          cat "$REPORT_FILE"

  output:
    links:
      - title: GitHub Organization
        url: https://github.com/${{ parameters.githubOrganization }}
      - title: Migration Playbook
        url: https://devblogs.microsoft.com/all-things-azure/azure-devops-to-github-migration-playbook-unlocking-agentic-devops/
      - title: Azure DevOps Project
        url: https://dev.azure.com/${{ parameters.adoOrganization }}/${{ parameters.adoProject }}
