# =============================================================================
# AZURE DEVOPS HYBRID SYNC WORKFLOW
# =============================================================================
#
# Enables hybrid mode: Code on GitHub + Azure Boards for project management
# This is CRITICAL for LATAM market where Azure Boards is widely used.
#
# Features:
#   - Syncs GitHub commits to Azure Boards work items
#   - Updates work item state based on PR status
#   - Bidirectional link creation (Azure Boards <-> GitHub)
#   - Supports AB#123 syntax for work item linking
#
# Microsoft Guidance:
# https://docs.microsoft.com/azure/devops/boards/github/link-to-from-github
#
# =============================================================================

name: Azure Boards Sync

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    types: [opened, synchronize, closed]
  issues:
    types: [opened, edited, closed]
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'Sync mode'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
          - validate

env:
  ADO_ORGANIZATION: ${{ vars.ADO_ORGANIZATION }}
  ADO_PROJECT: ${{ vars.ADO_PROJECT }}
  GITHUB_REPO: ${{ github.repository }}

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ===========================================================================
  # SYNC COMMITS TO WORK ITEMS
  # ===========================================================================
  sync-commits:
    name: Sync Commits to Azure Boards
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Extract Work Item References
        id: extract
        run: |
          echo "=== Extracting Azure Boards work item references ==="
          
          # Get commits in this push
          COMMITS="${{ github.event.before }}..${{ github.sha }}"
          
          # Extract AB#123 patterns from commit messages
          WORK_ITEMS=$(git log $COMMITS --pretty=format:"%s %b" 2>/dev/null | \
            grep -oE 'AB#[0-9]+' | sort -u | tr '\n' ',' | sed 's/,$//')
          
          if [[ -z "$WORK_ITEMS" ]]; then
            echo "No work item references found in commits"
            echo "work_items=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found work items: $WORK_ITEMS"
          echo "work_items=$WORK_ITEMS" >> $GITHUB_OUTPUT
          
      - name: Update Azure Boards Work Items
        if: steps.extract.outputs.work_items != ''
        env:
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          echo "=== Updating Azure Boards work items ==="
          
          IFS=',' read -ra ITEMS <<< "${{ steps.extract.outputs.work_items }}"
          
          for item in "${ITEMS[@]}"; do
            # Extract ID from AB#123
            WORK_ITEM_ID="${item#AB#}"
            
            echo "Updating work item: $WORK_ITEM_ID"
            
            # Add GitHub commit link to work item
            curl -s -X PATCH \
              -H "Content-Type: application/json-patch+json" \
              -H "Authorization: Basic $(echo -n ":$ADO_PAT" | base64)" \
              "https://dev.azure.com/$ADO_ORGANIZATION/$ADO_PROJECT/_apis/wit/workitems/$WORK_ITEM_ID?api-version=7.0" \
              -d '[
                {
                  "op": "add",
                  "path": "/relations/-",
                  "value": {
                    "rel": "ArtifactLink",
                    "url": "vstfs:///Git/Commit/${{ github.repository }}/${{ github.sha }}",
                    "attributes": {
                      "name": "GitHub Commit",
                      "comment": "Linked via Three Horizons ADO Hybrid Sync"
                    }
                  }
                }
              ]' || echo "Warning: Could not update work item $WORK_ITEM_ID"
              
            echo "‚úÖ Updated work item $WORK_ITEM_ID"
          done

  # ===========================================================================
  # SYNC PULL REQUESTS TO WORK ITEMS
  # ===========================================================================
  sync-pull-request:
    name: Sync PR to Azure Boards
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Extract Work Item from PR
        id: extract
        run: |
          # Check PR title and body for AB# references
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          
          WORK_ITEMS=$(echo "$PR_TITLE $PR_BODY" | \
            grep -oE 'AB#[0-9]+' | sort -u | head -5 | tr '\n' ',' | sed 's/,$//')
          
          echo "work_items=$WORK_ITEMS" >> $GITHUB_OUTPUT
          
      - name: Update Work Item State
        if: steps.extract.outputs.work_items != ''
        env:
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          IFS=',' read -ra ITEMS <<< "${{ steps.extract.outputs.work_items }}"
          
          # Determine new state based on PR action
          case "${{ github.event.action }}" in
            opened)
              STATE="Active"
              ;;
            synchronize)
              STATE="Active"
              ;;
            closed)
              if [[ "${{ github.event.pull_request.merged }}" == "true" ]]; then
                STATE="Resolved"
              else
                STATE="Active"
              fi
              ;;
          esac
          
          for item in "${ITEMS[@]}"; do
            WORK_ITEM_ID="${item#AB#}"
            
            echo "Updating work item $WORK_ITEM_ID to state: $STATE"
            
            # Update state and add PR link
            curl -s -X PATCH \
              -H "Content-Type: application/json-patch+json" \
              -H "Authorization: Basic $(echo -n ":$ADO_PAT" | base64)" \
              "https://dev.azure.com/$ADO_ORGANIZATION/$ADO_PROJECT/_apis/wit/workitems/$WORK_ITEM_ID?api-version=7.0" \
              -d "[
                {
                  \"op\": \"add\",
                  \"path\": \"/fields/System.State\",
                  \"value\": \"$STATE\"
                },
                {
                  \"op\": \"add\",
                  \"path\": \"/relations/-\",
                  \"value\": {
                    \"rel\": \"ArtifactLink\",
                    \"url\": \"vstfs:///Git/PullRequestId/${{ github.repository }}/${{ github.event.pull_request.number }}\",
                    \"attributes\": {
                      \"name\": \"GitHub Pull Request\",
                      \"comment\": \"PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}\"
                    }
                  }
                }
              ]" || echo "Warning: Could not update work item $WORK_ITEM_ID"
          done

      - name: Add Azure Boards Link to PR
        if: steps.extract.outputs.work_items != ''
        uses: actions/github-script@v7
        with:
          script: |
            const workItems = '${{ steps.extract.outputs.work_items }}'.split(',');
            const adoOrg = '${{ env.ADO_ORGANIZATION }}';
            const adoProject = '${{ env.ADO_PROJECT }}';
            
            let body = '## üîó Linked Azure Boards Work Items\n\n';
            
            workItems.forEach(item => {
              const id = item.replace('AB#', '');
              const url = `https://dev.azure.com/${adoOrg}/${adoProject}/_workitems/edit/${id}`;
              body += `- [${item}](${url})\n`;
            });
            
            body += '\n---\n*Synced by Three Horizons ADO Hybrid Integration*';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

  # ===========================================================================
  # AZURE PIPELINES INTEGRATION
  # ===========================================================================
  trigger-azure-pipeline:
    name: Trigger Azure Pipeline (if configured)
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      vars.ADO_PIPELINE_ID != ''
    
    steps:
      - name: Trigger Azure Pipeline
        env:
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          echo "=== Triggering Azure Pipeline ==="
          
          PIPELINE_ID="${{ vars.ADO_PIPELINE_ID }}"
          
          # Queue a new build
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Basic $(echo -n ":$ADO_PAT" | base64)" \
            "https://dev.azure.com/$ADO_ORGANIZATION/$ADO_PROJECT/_apis/pipelines/$PIPELINE_ID/runs?api-version=7.0" \
            -d '{
              "resources": {
                "repositories": {
                  "self": {
                    "refName": "refs/heads/main"
                  }
                }
              },
              "templateParameters": {
                "triggeredBy": "GitHub",
                "commitSha": "${{ github.sha }}",
                "repository": "${{ github.repository }}"
              }
            }' | jq '.'
            
          echo "‚úÖ Azure Pipeline triggered"

  # ===========================================================================
  # SYNC ISSUES (GitHub -> ADO)
  # ===========================================================================
  sync-issues:
    name: Sync GitHub Issues to ADO
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && vars.SYNC_ISSUES_TO_ADO == 'true'
    
    steps:
      - name: Create/Update ADO Work Item
        env:
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY="${{ github.event.issue.body }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_STATE="${{ github.event.issue.state }}"
          
          # Map GitHub state to ADO state
          if [[ "$ISSUE_STATE" == "closed" ]]; then
            ADO_STATE="Closed"
          else
            ADO_STATE="New"
          fi
          
          case "${{ github.event.action }}" in
            opened)
              echo "Creating new ADO work item for GitHub issue #${{ github.event.issue.number }}"
              
              # Create work item
              RESPONSE=$(curl -s -X POST \
                -H "Content-Type: application/json-patch+json" \
                -H "Authorization: Basic $(echo -n ":$ADO_PAT" | base64)" \
                "https://dev.azure.com/$ADO_ORGANIZATION/$ADO_PROJECT/_apis/wit/workitems/\$User%20Story?api-version=7.0" \
                -d "[
                  {\"op\": \"add\", \"path\": \"/fields/System.Title\", \"value\": \"[GitHub] $ISSUE_TITLE\"},
                  {\"op\": \"add\", \"path\": \"/fields/System.Description\", \"value\": \"$ISSUE_BODY\n\n---\nGitHub Issue: $ISSUE_URL\"},
                  {\"op\": \"add\", \"path\": \"/fields/System.Tags\", \"value\": \"github-sync\"}
                ]")
              
              WORK_ITEM_ID=$(echo "$RESPONSE" | jq -r '.id')
              echo "Created work item: $WORK_ITEM_ID"
              ;;
              
            closed)
              echo "Issue closed - would update corresponding ADO work item"
              ;;
          esac

  # ===========================================================================
  # VALIDATION JOB
  # ===========================================================================
  validate-integration:
    name: Validate ADO Integration
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.sync_mode == 'validate'
    
    steps:
      - name: Validate ADO Connection
        env:
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          echo "=== Validating Azure DevOps Integration ==="
          echo ""
          
          # Check organization access
          echo "1. Checking organization access..."
          ORG_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Basic $(echo -n ":$ADO_PAT" | base64)" \
            "https://dev.azure.com/$ADO_ORGANIZATION/_apis/projects?api-version=7.0")
          
          HTTP_CODE=$(echo "$ORG_RESPONSE" | tail -1)
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "   ‚úÖ Organization access: OK"
          else
            echo "   ‚ùå Organization access: FAILED (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Check project access
          echo "2. Checking project access..."
          PROJECT_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Basic $(echo -n ":$ADO_PAT" | base64)" \
            "https://dev.azure.com/$ADO_ORGANIZATION/$ADO_PROJECT/_apis/wit/workitemtypes?api-version=7.0")
          
          HTTP_CODE=$(echo "$PROJECT_RESPONSE" | tail -1)
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "   ‚úÖ Project access: OK"
          else
            echo "   ‚ùå Project access: FAILED (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Check Azure Pipelines GitHub App
          echo "3. Checking Azure Pipelines GitHub App..."
          if [[ -n "${{ vars.ADO_PIPELINE_ID }}" ]]; then
            echo "   ‚úÖ Pipeline ID configured: ${{ vars.ADO_PIPELINE_ID }}"
          else
            echo "   ‚ö†Ô∏è  No pipeline ID configured (optional)"
          fi
          
          echo ""
          echo "=== Validation Complete ==="
          echo "‚úÖ Azure DevOps hybrid integration is properly configured"

# =============================================================================
# CONFIGURATION NOTES
# =============================================================================
#
# Required Secrets:
#   ADO_PAT - Azure DevOps Personal Access Token with:
#     - Work Items (Read, Write)
#     - Build (Read, Execute)
#     - Code (Read)
#
# Required Variables:
#   ADO_ORGANIZATION - Azure DevOps organization name
#   ADO_PROJECT - Azure DevOps project name
#
# Optional Variables:
#   ADO_PIPELINE_ID - Pipeline ID to trigger (enables CI hybrid mode)
#   SYNC_ISSUES_TO_ADO - Set to 'true' to sync GitHub issues
#
# Azure Pipelines GitHub App:
#   Install from: https://github.com/marketplace/azure-pipelines
#   This enables Azure Pipelines to use GitHub as source
#
# Documentation:
#   - https://docs.microsoft.com/azure/devops/boards/github/link-to-from-github
#   - https://devblogs.microsoft.com/all-things-azure/azure-devops-to-github-migration-playbook
#
# =============================================================================
