name: Deploy Infrastructure

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name'
        required: true
      sizing_profile:
        description: 'Sizing profile'
        required: true
        type: choice
        options:
          - small
          - medium
          - large
          - xlarge

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent:infrastructure') && contains(github.event.issue.labels.*.name, 'approved')) ||
      (github.event_name == 'workflow_dispatch')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Parse issue configuration
        if: github.event_name == 'issues'
        id: parse
        uses: stefanbuck/github-issue-parser@v3
        with:
          template-path: .github/ISSUE_TEMPLATE/infrastructure.yml
      
      - name: Set environment variables
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "PROJECT_NAME=${{ github.event.inputs.project_name }}" >> $GITHUB_ENV
            echo "SIZING_PROFILE=${{ github.event.inputs.sizing_profile }}" >> $GITHUB_ENV
          else
            echo "PROJECT_NAME=${{ fromJson(steps.parse.outputs.jsonString).project_name }}" >> $GITHUB_ENV
            echo "REGION=${{ fromJson(steps.parse.outputs.jsonString).region }}" >> $GITHUB_ENV
            echo "SIZING_PROFILE=${{ fromJson(steps.parse.outputs.jsonString).sizing_profile }}" >> $GITHUB_ENV
          fi
          echo "RESOURCE_GROUP=${PROJECT_NAME}-rg" >> $GITHUB_ENV
      
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"
      
      - name: Terraform Init
        run: |
          cd terraform
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TF_STATE_RG }}" \
            -backend-config="storage_account_name=${{ secrets.TF_STATE_STORAGE }}" \
            -backend-config="container_name=${{ secrets.TF_STATE_CONTAINER }}" \
            -backend-config="key=${PROJECT_NAME}.tfstate"
      
      - name: Terraform Plan
        run: |
          cd terraform
          terraform plan \
            -var="project_name=${PROJECT_NAME}" \
            -var="region=${REGION:-brazilsouth}" \
            -var="sizing_profile=${SIZING_PROFILE}" \
            -out=tfplan
      
      - name: Terraform Apply
        run: |
          cd terraform
          terraform apply -auto-approve tfplan
      
      - name: Get Outputs
        id: tf-outputs
        run: |
          cd terraform
          echo "AKS_NAME=$(terraform output -raw aks_cluster_name)" >> $GITHUB_OUTPUT
          echo "ACR_NAME=$(terraform output -raw acr_name)" >> $GITHUB_OUTPUT
          echo "VNET_NAME=$(terraform output -raw vnet_name)" >> $GITHUB_OUTPUT
      
      - name: Validate Deployment
        run: |
          chmod +x scripts/validate-deployment.sh
          ./scripts/validate-deployment.sh ${RESOURCE_GROUP}
      
      - name: Comment success on issue
        if: github.event_name == 'issues' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Infrastructure Deployed Successfully**\n\n**Resources:**\n- Resource Group: ${process.env.RESOURCE_GROUP}\n- AKS Cluster: ${{ steps.tf-outputs.outputs.AKS_NAME }}\n- ACR: ${{ steps.tf-outputs.outputs.ACR_NAME }}\n- VNet: ${{ steps.tf-outputs.outputs.VNET_NAME }}\n\n**Next Steps:**\n1. Deploy networking (label issue with \`agent:networking\`)\n2. Configure security (label issue with \`agent:security\`)`
            })
      
      - name: Close issue
        if: github.event_name == 'issues' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: ['completed']
            })
