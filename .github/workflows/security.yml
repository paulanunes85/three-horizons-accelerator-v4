# =============================================================================
# GHAS + DEFENDER FOR CLOUD SECURITY WORKFLOW
# =============================================================================
#
# Unified security scanning integrating GitHub Advanced Security with
# Microsoft Defender for Cloud for code-to-cloud visibility.
#
# Features:
#   - CodeQL code scanning
#   - Secret scanning validation
#   - Dependency review
#   - Container image scanning
#   - IaC security scanning (Terraform, Kubernetes)
#   - SARIF upload to Defender for Cloud
#   - Security posture assessment
#
# Documentation:
# https://learn.microsoft.com/en-us/azure/defender-for-cloud/github-action
#
# =============================================================================

name: Security Scan (GHAS + Defender)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Daily at 4:30 AM UTC
    - cron: '30 4 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of scan to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - code
          - dependencies
          - containers
          - infrastructure

permissions:
  contents: read
  security-events: write
  pull-requests: write
  id-token: write  # Required for OIDC auth to Azure

env:
  # Azure configuration (uses OIDC federation)
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

jobs:
  # ===========================================================================
  # CODE SCANNING (CodeQL)
  # ===========================================================================
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'code' || github.event.inputs.scan_type == ''
    timeout-minutes: 360

    strategy:
      fail-fast: false
      matrix:
        language: [python, javascript]  # Customize based on repo
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
          config: |
            paths-ignore:
              - '**/test/**'
              - '**/tests/**'
              - '**/__tests__/**'
              - '**/node_modules/**'
              - '**/vendor/**'

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          output: sarif-results
          add-snippets: true

      - name: Upload SARIF to Defender for Cloud
        if: always()
        uses: azure/CLI@v2
        with:
          azcliversion: 2.57.0
          inlineScript: |
            # Login using OIDC
            az login --service-principal \
              -u ${{ env.AZURE_CLIENT_ID }} \
              --tenant ${{ env.AZURE_TENANT_ID }} \
              --federated-token $(cat $ACTIONS_ID_TOKEN_REQUEST_TOKEN)
            
            # Upload SARIF to Defender (if configured)
            if [[ -f "sarif-results/${{ matrix.language }}.sarif" ]]; then
              echo "SARIF file found, integration with Defender is via GitHub connector"
            fi

  # ===========================================================================
  # DEPENDENCY SCANNING
  # ===========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: always
          deny-licenses: GPL-3.0, AGPL-3.0
          allow-ghsas: false

  # ===========================================================================
  # SECRET SCANNING VALIDATION
  # ===========================================================================
  secret-scan-check:
    name: Secret Scanning Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

      - name: Validate no hardcoded secrets
        run: |
          echo "=== Checking for common secret patterns ==="
          
          # Check for AWS keys
          if grep -rE "AKIA[0-9A-Z]{16}" . --include="*.py" --include="*.js" --include="*.ts" --include="*.yaml" --include="*.yml" 2>/dev/null; then
            echo "âŒ Potential AWS access key found!"
            exit 1
          fi
          
          # Check for Azure secrets
          if grep -rE "DefaultEndpointsProtocol=https;AccountName=" . --include="*.py" --include="*.js" --include="*.ts" --include="*.yaml" --include="*.yml" 2>/dev/null; then
            echo "âŒ Potential Azure connection string found!"
            exit 1
          fi
          
          # Check for private keys
          if grep -rE "-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----" . --include="*.pem" --include="*.key" 2>/dev/null; then
            echo "âŒ Private key file found in repository!"
            exit 1
          fi
          
          echo "âœ… No obvious secrets detected"

  # ===========================================================================
  # INFRASTRUCTURE AS CODE SCANNING
  # ===========================================================================
  iac-scanning:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'infrastructure' || github.event.inputs.scan_type == ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Terraform Security Scan
      - name: tfsec - Terraform Security
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform/
          format: sarif
          sarif_file: tfsec-results.sarif
        continue-on-error: true

      - name: Upload tfsec SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: tfsec-results.sarif
          category: tfsec

      # Kubernetes Security Scan
      - name: kubesec - Kubernetes Security
        run: |
          echo "=== Scanning Kubernetes manifests ==="
          
          # Install kubesec
          wget -q https://github.com/controlplaneio/kubesec/releases/download/v2.14.0/kubesec_linux_amd64.tar.gz
          tar xzf kubesec_linux_amd64.tar.gz
          chmod +x kubesec
          
          # Scan manifests
          FAILED=0
          for file in $(find . -name "*.yaml" -o -name "*.yml" | xargs grep -l "kind:" 2>/dev/null); do
            if grep -q "apiVersion:" "$file"; then
              echo "Scanning: $file"
              ./kubesec scan "$file" || FAILED=1
            fi
          done
          
          if [[ $FAILED -eq 1 ]]; then
            echo "âš ï¸  Some manifests have security issues"
          else
            echo "âœ… Kubernetes manifests passed security scan"
          fi
        continue-on-error: true

      # Checkov - Multi-framework IaC scanner
      - name: Checkov - IaC Security
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform,kubernetes,helm,dockerfile
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results.sarif
          category: checkov

  # ===========================================================================
  # CONTAINER IMAGE SCANNING
  # ===========================================================================
  container-scanning:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type == 'all' || github.event.inputs.scan_type == 'containers' || github.event.inputs.scan_type == ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find Dockerfiles
        id: find-dockerfiles
        run: |
          DOCKERFILES=$(find . -name "Dockerfile*" -type f | head -5 | tr '\n' ' ')
          echo "dockerfiles=$DOCKERFILES" >> $GITHUB_OUTPUT
          echo "Found Dockerfiles: $DOCKERFILES"

      - name: Build and Scan Container Images
        if: steps.find-dockerfiles.outputs.dockerfiles != ''
        run: |
          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update && sudo apt-get install -y trivy
          
          for dockerfile in ${{ steps.find-dockerfiles.outputs.dockerfiles }}; do
            DIR=$(dirname "$dockerfile")
            NAME=$(basename "$DIR")
            
            echo "=== Building and scanning: $NAME ==="
            
            # Build image
            docker build -t "scan-$NAME:latest" -f "$dockerfile" "$DIR" || continue
            
            # Scan with Trivy
            trivy image --format sarif --output "trivy-$NAME.sarif" "scan-$NAME:latest" || true
          done

      - name: Upload Trivy SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-*.sarif
          category: trivy
        continue-on-error: true

  # ===========================================================================
  # DEFENDER FOR CLOUD POSTURE CHECK
  # ===========================================================================
  defender-posture:
    name: Defender Security Posture
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [codeql-analysis, iac-scanning]
    
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Check Defender Recommendations
        run: |
          echo "=== Checking Defender for Cloud Recommendations ==="
          
          # Get security recommendations related to this repo
          az security assessment list \
            --query "[?contains(resourceDetails.source, 'GitHub')].{name:displayName, status:status.code}" \
            -o table || echo "No GitHub-specific recommendations found"
          
          # Get overall secure score
          SCORE=$(az security secure-score list --query "[0].current" -o tsv 2>/dev/null || echo "N/A")
          echo ""
          echo "ðŸ“Š Current Secure Score: $SCORE"

      - name: Post Security Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## ðŸ”’ Security Scan Summary
            
            **Repository:** ${context.repo.owner}/${context.repo.repo}
            **Commit:** ${context.sha.substring(0, 7)}
            **Branch:** ${context.ref.replace('refs/heads/', '')}
            
            ### Scan Results
            
            | Scanner | Status |
            |---------|--------|
            | CodeQL | âœ… Completed |
            | Dependency Review | âœ… Completed |
            | Secret Scanning | âœ… Completed |
            | IaC Scanning | âœ… Completed |
            | Container Scanning | âœ… Completed |
            
            ### Integration Status
            
            - **GitHub Security Tab:** [View Alerts](https://github.com/${context.repo.owner}/${context.repo.repo}/security)
            - **Defender for Cloud:** Findings synced via GitHub connector
            
            ---
            *Scanned by Three Horizons Security Pipeline*
            `;
            
            core.summary.addRaw(summary).write();

# =============================================================================
# REUSABLE WORKFLOW CONFIGURATION
# =============================================================================
#
# To use this workflow in other repositories:
#
# name: Security
# on: [push, pull_request]
#
# jobs:
#   security:
#     uses: ${GITHUB_ORG}/three-horizons-accelerator/.github/workflows/security.yml@main
#     secrets: inherit
#     with:
#       scan_type: all
#
# =============================================================================
