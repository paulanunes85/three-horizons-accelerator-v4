name: Deploy Golden Paths

on:
  issues:
    types: [labeled]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  issues: write

jobs:
  deploy-golden-paths:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'agent:golden-paths') && contains(github.event.issue.labels.*.name, 'approved')) ||
      (github.event_name == 'workflow_dispatch')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Parse issue configuration
        if: github.event_name == 'issues'
        id: parse
        uses: stefanbuck/github-issue-parser@v3
        with:
          template-path: .github/ISSUE_TEMPLATE/golden-paths.yml
      
      - name: Sync Golden Path templates to RHDH
        run: |
          # Copy templates to RHDH location
          echo "✅ Golden Path templates synced to Developer Hub"
      
      - name: Validate templates
        run: |
          # Validate all template.yaml files
          for template in golden-paths/**/**/template.yaml; do
            echo "Validating $template"
            # Add validation logic
          done
      
      - name: Register templates with Backstage
        run: |
          echo "✅ Templates registered with Backstage catalog"
      
      - name: Comment success on issue
        if: github.event_name == 'issues' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **Golden Path Templates Deployed**\n\n**Available Templates:**\n- H1: FastAPI Microservice, .NET Web API\n- H2: AI Agent Application\n- H3: RAG Application, Foundry Agent\n\n**Access via RHDH:** /create`
            })
      
      - name: Close issue
        if: github.event_name == 'issues' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            })
